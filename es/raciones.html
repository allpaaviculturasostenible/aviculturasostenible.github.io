<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allpa ¬∑ Calculadora diaria de raciones</title>
  <!-- Tailwind por CDN para estilos ligeros -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Peque√±os ajustes */
    .card{ @apply bg-white border border-neutral-200 rounded-2xl p-4 md:p-6; }
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <!-- Header solo en verdes -->
  <div class="w-full text-white bg-gradient-to-r from-emerald-800 via-emerald-700 to-emerald-500">
    <header class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl sm:text-2xl font-bold tracking-tight">Allpa ¬∑ Calculadora diaria de raciones</h1>
      <button id="btnShare" class="rounded-xl bg-white/10 hover:bg-white/20 px-3 py-1.5 text-sm">Compartir</button>
    </header>
  </div>  <main class="max-w-5xl mx-auto px-4 py-6 grid gap-6" style="padding-bottom:80px">
    <!-- Datos del lote -->
    <section class="card grid gap-4">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <h2 class="text-lg font-semibold">Datos del lote</h2>
        <div id="savedWrap" class="hidden flex items-center gap-2">
          <label class="text-sm" for="savedSelect">Cargar registro:</label>
          <select id="savedSelect" class="rounded-xl border px-3 py-2 text-sm"></select>
        </div>
      </div><div class="grid sm:grid-cols-5 gap-4 items-center">
    <div class="sm:col-span-1">
      <label class="text-sm font-medium">Raza</label>
      <select id="breed" class="mt-1 w-full rounded-xl border px-3 py-2">
        <option value="cobb500">Cobb 500</option>
        <option value="ross308">Ross 308</option>
        <option value="hubbard">Hubbard</option>
        <option value="otra">Otra / mi l√≠nea</option>
      </select>
    </div>
    <div class="sm:col-span-1">
      <label class="text-sm font-medium">Cantidad de pollos</label>
      <input id="count" type="number" min="1" value="100" class="mt-1 w-full rounded-xl border px-3 py-2" />
    </div>
    <div class="sm:col-span-1">
      <label class="text-sm font-medium">Comederos</label>
      <input id="feeders" type="number" min="1" value="8" class="mt-1 w-full rounded-xl border px-3 py-2" />
    </div>
    <div class="sm:col-span-2">
      <label class="text-sm font-medium flex items-center justify-between">
        <span>Edad (d√≠as)</span>
        <span class="text-xs text-neutral-600">D√≠a seleccionado: <b id="ageLabel">1</b>/56</span>
      </label>
      <input id="age" type="range" min="1" max="56" value="1" class="mt-2 w-full" />
    </div>
  </div>
  <p class="text-sm text-neutral-600">Al guardar, se registran autom√°ticamente las observaciones y la hora para trazabilidad.</p>
</section>

<!-- Resultados -->
<section class="card grid gap-6">
  <h2 class="text-lg font-semibold">Resultados de hoy</h2>
  <div class="grid md:grid-cols-2 gap-4">
    <div class="rounded-xl border p-4 bg-neutral-50">
      <p class="text-xs uppercase tracking-wide text-neutral-600">Consumo recomendado (g/ave/d√≠a)</p>
      <p id="statIntake" class="text-xl font-semibold">0 g</p>
    </div>
    <div class="rounded-xl border p-4 bg-neutral-50">
      <p class="text-xs uppercase tracking-wide text-neutral-600">Total de alimento (kg/d√≠a)</p>
      <p id="statTotal" class="text-xl font-semibold">0 kg</p>
    </div>
  </div>

  <div class="rounded-xl border p-4">
    <p class="font-medium mb-2">Horario recomendado</p>
    <p id="scheduleSummary" class="text-sm text-neutral-700 mb-3"></p>
    <div id="scheduleTableWrap" class="overflow-auto"></div>
  </div>

  <div class="grid md:grid-cols-2 gap-4 items-start">
    <div>
      <label class="text-sm font-medium">Observaciones de hoy</label>
      <textarea id="note" rows="4" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Ej.: consumo bajo por calor al mediod√≠a, mejorar ventilaci√≥n"></textarea>
    </div>
    <div class="rounded-xl border p-4 grid gap-3">
      <button id="btnSave" class="w-full rounded-xl bg-emerald-600 text-white py-2 font-medium hover:bg-emerald-700 transition">üíæ Guardar registro de hoy</button>
      <p class="text-xs text-neutral-600">√öltimo guardado: <span id="lastSave">‚Äî</span></p>
      <div id="yesterdayWrap" class="hidden text-sm bg-neutral-50 rounded-lg border p-3">
        <p class="font-medium mb-1">Ayer (<span id="yesterdayDate"></span>)</p>
        <ul class="text-xs list-disc ml-4 space-y-1">
          <li>Edad: <span id="yAge"></span> d√≠as</li>
          <li>Consumo: <span id="yIntake"></span> g/ave/d√≠a</li>
          <li>Total alimento: <span id="yTotal"></span> kg</li>
        </ul>
      </div>
    </div>
  </div>
</section>

<!-- Buenas pr√°cticas (colapsable) -->
<section class="card">
  <details>
    <summary class="cursor-pointer select-none text-lg font-semibold">Buenas pr√°cticas r√°pidas</summary>
    <ul class="mt-3 text-sm space-y-2 list-disc ml-5 text-neutral-700">
      <li>En d√≠as 3‚Äì5, usa raciones peque√±as y frecuentes para estimular el consumo.</li>
      <li>En climas c√°lidos, prioriza mayor % de la raci√≥n en la ma√±ana.</li>
      <li>Revisa a diario ventilaci√≥n, cama, agua y comportamiento.</li>
      <li>Pesa una muestra de aves semanalmente para validar el consumo real vs. esperado.</li>
    </ul>
  </details>
</section>

  </main>  <!-- JS puro, sin TypeScript ni React -->  <script>
  (function(){
    // ===== Utilidades =====
    const $ = (sel)=>document.querySelector(sel);
    const nowIso = ()=>new Date().toISOString();
    const todayKey = ()=>new Date().toISOString().slice(0,10);
    function formatG(v){return `${Math.round(v)} g`}
    function formatKg(v){return `${(v/1000).toFixed(2)} kg`}

    // ==== Curvas oficiales (g/ave/d√≠a) ====
    const rossDaily = [
      12,16,20,24,27,31,35,39,44,48,52,57,62,67,72,77,83,88,
      94,100,105,111,117,122,128,134,139,145,150,156,161,166,
      171,176,180,185,189,193,197,201,204,207,211,213,216,219,
      221,223,225,227,229,230,231,233,233,234,
    ];
    const cobbDaily = [
      14,18,22,25,29,33,37,40,44,50,57,64,73,80,84,91,98,105,
      111,118,125,131,137,143,149,154,160,165,169,174,178,183,
      187,191,194,198,202,206,209,213,217,220,224,228,232,236,
      239,243,247,250,253,256,258,260,261,262,
    ];

    function getDailyIntake(breed, day){
      const idx = Math.max(1, Math.min(56, day)) - 1;
      if(breed==='ross308') return rossDaily[idx];
      if(breed==='cobb500') return cobbDaily[idx];
      return Math.round(((rossDaily[idx]||0)+(cobbDaily[idx]||0))/2); // Hubbard/Otra: promedio
    }

    function scheduleForAge(age){
      if(age<=2) return {mode:'adlib', summary:'D√≠as 1‚Äì2: alimentaci√≥n a voluntad (24/7)', details:['Comederos siempre llenos y accesibles.']};
      if(age<=5) return {mode:'six', summary:'D√≠as 3‚Äì5: 6 raciones peque√±as para estimular consumo', details:['6:00','9:00','12:00','15:00','17:00','19:00']};
      return {mode:'two', summary:'Desde d√≠a 6: 2 raciones (ma√±ana y tarde)', details:['6:00 (Raci√≥n 1)','17:00 (Raci√≥n 2)']};
    }

    // ===== Elementos =====
    const breedEl = $('#breed');
    const countEl = $('#count');
    const feedersEl = $('#feeders');
    const ageEl = $('#age');
    const ageLabel = $('#ageLabel');
    const noteEl = $('#note');

    const statIntake = $('#statIntake');
    const statTotal = $('#statTotal');
    const scheduleSummary = $('#scheduleSummary');
    const scheduleTableWrap = $('#scheduleTableWrap');

    const savedWrap = $('#savedWrap');
    const savedSelect = $('#savedSelect');
    const lastSave = $('#lastSave');
    const yWrap = $('#yesterdayWrap');
    const yDate = $('#yesterdayDate');
    const yAge = $('#yAge');
    const yIntake = $('#yIntake');
    const yTotal = $('#yTotal');

    const btnSave = $('#btnSave');
    const btnShare = $('#btnShare');

    // ===== Store =====
    const LS_KEY = 'allpa_calc_raciones_html_light_v1';
    function loadStore(){ try{return JSON.parse(localStorage.getItem(LS_KEY))||{records:{},lastSave:null}}catch{return {records:{},lastSave:null}} }
    function saveStore(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }

    // ===== C√°lculos =====
    function recalc(){
      const breed = breedEl.value;
      const count = parseInt(countEl.value||'0');
      const feeders = Math.max(1, parseInt(feedersEl.value||'1'));
      const age = parseInt(ageEl.value||'1');

      const intake = getDailyIntake(breed, age); // g/ave/d√≠a
      const totalKg = (intake*count)/1000;

      statIntake.textContent = intake.toLocaleString('es-CO') + ' g';
      statTotal.textContent = totalKg.toFixed(2) + ' kg';

      const sch = scheduleForAge(age);
      scheduleSummary.textContent = sch.summary;

      if(sch.mode==='adlib'){
        scheduleTableWrap.innerHTML = '<div class="text-sm text-neutral-700">Asegura comederos disponibles las 24 horas. Cambia el alimento frecuentemente para mantenerlo fresco.</div>';
      } else {
        const birdsPerFeeder = Math.ceil(count / feeders);
        let rows = '';
        if(sch.mode==='six'){
          const per = intake/6; // g/ave por raci√≥n
          rows = sch.details.map(d=>{
            const totalG = per*count;
            const perFeederKg = (totalG/feeders)/1000;
            return `<tr class=\"border-t\"><td class=\"py-1\">${d}</td><td class=\"py-1\">${Math.round(per)} g</td><td class=\"py-1\">${(totalG/1000).toFixed(2)} kg</td><td class=\"py-1\">${perFeederKg.toFixed(2)} kg</td><td class=\"py-1\">${birdsPerFeeder}</td></tr>`;
          }).join('');
        } else {
          const r1 = Math.round(intake*0.6), r2 = intake - r1; // g/ave
          [r1,r2].forEach((r,i)=>{
            const totalG = r*count; const perFeederKg = (totalG/feeders)/1000;
            rows += `<tr class=\"border-t\"><td class=\"py-1\">${sch.details[i]}</td><td class=\"py-1\">${r} g</td><td class=\"py-1\">${(totalG/1000).toFixed(2)} kg</td><td class=\"py-1\">${perFeederKg.toFixed(2)} kg</td><td class=\"py-1\">${birdsPerFeeder}</td></tr>`;
          });
        }
        scheduleTableWrap.innerHTML = `<table class=\"w-full text-sm\"><thead><tr class=\"text-left text-neutral-600\"><th class=\"py-1\">Raci√≥n</th><th class=\"py-1\">g/ave</th><th class=\"py-1\">kg total</th><th class=\"py-1\">kg/comedero</th><th class=\"py-1\">aves/comedero</th></tr></thead><tbody>${rows}</tbody></table>`;
      }
    }

    function refreshSavedList(store){
      const keys = Object.keys(store.records).sort().reverse();
      if(keys.length===0){ savedWrap.classList.add('hidden'); return; }
      savedWrap.classList.remove('hidden');
      savedSelect.innerHTML = '<option value="">Selecciona‚Ä¶</option>' + keys.map(k=>{
        const r = store.records[k];
        return `<option value="${k}">${r.date} ¬∑ Edad ${r.age}d ¬∑ ${r.count} aves</option>`;
      }).join('');
    }

    function loadYesterday(store){
      const d = new Date(); d.setDate(d.getDate()-1); const yKey = d.toISOString().slice(0,10);
      const r = store.records[yKey];
      if(!r){ yWrap.classList.add('hidden'); return; }
      yWrap.classList.remove('hidden');
      yDate.textContent = r.date; yAge.textContent = r.age; yIntake.textContent = r.intakePerBirdG; yTotal.textContent = Number(r.totalIntakeKg).toFixed(2);
    }

    function saveToday(){
      const key = todayKey();
      const store = loadStore();
      const record = {
        date: key,
        savedAt: nowIso(),
        breed: breedEl.value,
        count: parseInt(countEl.value||'0'),
        feeders: Math.max(1, parseInt(feedersEl.value||'1')),
        age: parseInt(ageEl.value||'1'),
        intakePerBirdG: getDailyIntake(breedEl.value, parseInt(ageEl.value||'1')),
        totalIntakeKg: (getDailyIntake(breedEl.value, parseInt(ageEl.value||'1')) * parseInt(countEl.value||'0'))/1000,
        schedule: scheduleForAge(parseInt(ageEl.value||'1')),
        note: noteEl.value,
      };
      store.records[key] = record;
      store.lastSave = key;
      saveStore(store);
      lastSave.textContent = key;
      refreshSavedList(store);
      loadYesterday(store);
      alert('‚úÖ Registro guardado.');
    }

    function loadSaved(key){
      const store = loadStore(); const rec = store.records[key]; if(!rec) return;
      savedSelect.value = key;
      breedEl.value = rec.breed; countEl.value = rec.count; feedersEl.value = rec.feeders; ageEl.value = rec.age; ageLabel.textContent = rec.age; noteEl.value = rec.note||'';
      recalc();
    }

    function initFromURL(){
      const p = new URLSearchParams(location.search);
      const b = p.get('breed'); const c = p.get('count'); const a = p.get('age'); const n = p.get('note'); const f = p.get('feeders');
      if(b) breedEl.value = b;
      if(c && !isNaN(parseInt(c))) countEl.value = parseInt(c);
      if(a && !isNaN(parseInt(a))) { ageEl.value = Math.max(1,Math.min(56,parseInt(a))); ageLabel.textContent = ageEl.value; }
      if(n) noteEl.value = n;
      if(f && !isNaN(parseInt(f))) feedersEl.value = Math.max(1, parseInt(f));
    }

    function buildShareUrl(){
      const base = location.origin + location.pathname;
      const p = new URLSearchParams();
      p.set('breed', breedEl.value);
      p.set('count', String(parseInt(countEl.value||'0')));
      p.set('age', String(parseInt(ageEl.value||'1')));
      p.set('feeders', String(Math.max(1, parseInt(feedersEl.value||'1'))));
      if(noteEl.value) p.set('note', noteEl.value);
      return `${base}?${p.toString()}`;
    }

    async function share(){
      const url = buildShareUrl();
      try{
        if(navigator.share){ await navigator.share({title:'Allpa ¬∑ Calculadora de raciones', text:'Consulta de raciones precargada', url}); }
        else { await navigator.clipboard.writeText(url); alert('üîó Enlace copiado al portapapeles'); }
      }catch(e){ /* cancel */ }
    }

    // Eventos
    ['input','change'].forEach(evt=>{
      ageEl.addEventListener(evt,()=>{ ageLabel.textContent = ageEl.value; recalc(); });
      countEl.addEventListener(evt,recalc);
      feedersEl.addEventListener(evt,recalc);
      breedEl.addEventListener(evt,recalc);
      noteEl.addEventListener(evt,()=>{});
    });
    btnSave.addEventListener('click', saveToday);
    btnShare.addEventListener('click', share);
    savedSelect.addEventListener('change', ()=>{ if(savedSelect.value) loadSaved(savedSelect.value); });

    // Arranque
    (function start(){
      const store = loadStore();
      lastSave.textContent = store.lastSave || '‚Äî';
      refreshSavedList(store);
      loadYesterday(store);
      initFromURL();
      recalc();
    })();
  })();
  </script></body>
</html>