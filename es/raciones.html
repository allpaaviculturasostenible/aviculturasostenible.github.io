import React, { useEffect, useMemo, useState } from "react";

/**

Allpa ‚Äì Calculadora diaria de raciones para pollos (v4 ‚Äì ligera)

Cambios:

Quita racha, peso esperado, tipo de alimento, consejo del d√≠a y progreso del ciclo.


Buenas pr√°cticas en bloque colapsable <details>.


Quita footer sticky (se reemplazar√° por el JS anterior del sitio).


A√±ade "N√∫mero de comederos" para dividir raciones y mostrar kg por comedero y aves/comedero.


Curvas de consumo por raza usando vectores oficiales Cobb 500 y Ross 308. */



// --- Utilidades --- const nowIso = () => new Date().toISOString(); const todayKey = () => new Date().toISOString().slice(0,10); function formatG(v: number) { return ${Math.round(v)} g; } function formatKg(v: number) { return ${(v/1000).toFixed(2)} kg; }

// ==== Curvas oficiales (g/ave/d√≠a) ==== const rossDaily: number[] = [ 12, 16, 20, 24, 27, 31, 35, 39, 44, 48, 52, 57, 62, 67, 72, 77, 83, 88, 94, 100, 105, 111, 117, 122, 128, 134, 139, 145, 150, 156, 161, 166, 171, 176, 180, 185, 189, 193, 197, 201, 204, 207, 211, 213, 216, 219, 221, 223, 225, 227, 229, 230, 231, 233, 233, 234, ]; const cobbDaily: number[] = [ 14, 18, 22, 25, 29, 33, 37, 40, 44, 50, 57, 64, 73, 80, 84, 91, 98, 105, 111, 118, 125, 131, 137, 143, 149, 154, 160, 165, 169, 174, 178, 183, 187, 191, 194, 198, 202, 206, 209, 213, 217, 220, 224, 228, 232, 236, 239, 243, 247, 250, 253, 256, 258, 260, 261, 262, ];

function getDailyIntake(breed: string, day: number): number { const idx = Math.max(1, Math.min(56, day)) - 1; // 0-based if (breed === "ross308") return rossDaily[idx]; if (breed === "cobb500") return cobbDaily[idx]; // promedio simple si es Hubbard u otra l√≠nea return Math.round(((rossDaily[idx] ?? 0) + (cobbDaily[idx] ?? 0)) / 2); }

// Razas const BREEDS = [ { value: "cobb500", label: "Cobb 500" }, { value: "ross308", label: "Ross 308" }, { value: "hubbard", label: "Hubbard" }, { value: "otra", label: "Otra / mi l√≠nea" }, ];

// Horarios type Schedule = { mode: "adlib" | "six" | "two"; summary: string; details: string[] }; function scheduleForAge(age: number): Schedule { if (age <= 2) return { mode: "adlib", summary: "D√≠as 1‚Äì2: alimentaci√≥n a voluntad (24/7)", details: ["Comederos siempre llenos y accesibles."] }; if (age <= 5) return { mode: "six", summary: "D√≠as 3‚Äì5: 6 raciones peque√±as para estimular consumo", details: ["6:00","9:00","12:00","15:00","17:00","19:00"] }; return { mode: "two", summary: "Desde d√≠a 6: 2 raciones (ma√±ana y tarde)", details: ["6:00 (Raci√≥n 1)","17:00 (Raci√≥n 2)"] }; }

// Persistencia const LS_KEY = "allpa_calc_raciones_v4";

type SavedRecord = { date: string; savedAt: string; breed: string; count: number; feeders: number; age: number; intakePerBirdG: number; totalIntakeKg: number; schedule: Schedule; note?: string; };

type Store = { records: Record<string, SavedRecord>; lastSave: string | null; };

export default function Page() { const [breed, setBreed] = useState("cobb500"); const [count, setCount] = useState<number>(100); const [feeders, setFeeders] = useState<number>(8); const [age, setAge] = useState<number>(1); const [note, setNote] = useState(""); const [lastSave, setLastSave] = useState<string | null>(null); const [yesterdayRecord, setYesterdayRecord] = useState<SavedRecord | null>(null); const [savedList, setSavedList] = useState<Array<SavedRecord>>([]); const [selectedKey, setSelectedKey] = useState<string>("");

// Derivados const schedule = useMemo(() => scheduleForAge(age), [age]); const intakePerBirdG = useMemo(() => getDailyIntake(breed, age), [breed, age]); const totalIntakeKg = useMemo(() => (intakePerBirdG * count) / 1000, [intakePerBirdG, count]); const birdsPerFeeder = useMemo(() => (feeders > 0 ? Math.ceil(count / feeders) : 0), [count, feeders]);

// Raciones por horario (con divisi√≥n por comederos) const rations = useMemo(() => { if (schedule.mode === "adlib") return [] as Array<{ label: string, perBirdG: string, totalKg: string, perFeederKg?: string }>; if (schedule.mode === "six") { const per = intakePerBirdG / 6; // g/ave por raci√≥n return schedule.details.map((d) => { const totalG = per * count; const perFeederKg = feeders > 0 ? (totalG / feeders) / 1000 : 0; return { label: d, perBirdG: formatG(per), totalKg: formatKg(totalG), perFeederKg: formatKg(perFeederKg * 1000) }; }); } const r1 = Math.round(intakePerBirdG * 0.6); const r2 = intakePerBirdG - r1; const rations = [r1, r2]; return rations.map((r, i) => { const totalG = r * count; const perFeederKg = feeders > 0 ? (totalG / feeders) / 1000 : 0; return { label: schedule.details[i], perBirdG: formatG(r), totalKg: formatKg(totalG), perFeederKg: formatKg(perFeederKg * 1000) }; }); }, [schedule, intakePerBirdG, count, feeders]);

// Carga inicial: store + URL params + ayer + lista useEffect(() => { try { const raw = localStorage.getItem(LS_KEY); const data: Store = raw ? JSON.parse(raw) : { records: {}, lastSave: null };

setLastSave(data.lastSave || null);

  // cargar AYER
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yKey = yesterday.toISOString().slice(0,10);
  if (data.records && data.records[yKey]) setYesterdayRecord(data.records[yKey]);

  // lista guardada
  const list = Object.values(data.records).sort((a,b)=> a.date < b.date ? 1 : -1);
  setSavedList(list);

  // precargar por URL
  const params = new URLSearchParams(window.location.search);
  const qBreed = params.get("breed");
  const qCount = params.get("count");
  const qAge = params.get("age");
  const qNote = params.get("note");
  const qFeeders = params.get("feeders");
  if (qBreed) setBreed(qBreed);
  if (qCount && !isNaN(parseInt(qCount))) setCount(parseInt(qCount));
  if (qAge && !isNaN(parseInt(qAge))) setAge(Math.max(1, Math.min(56, parseInt(qAge))));
  if (qNote) setNote(qNote);
  if (qFeeders && !isNaN(parseInt(qFeeders))) setFeeders(Math.max(1, parseInt(qFeeders)));
} catch { /* noop */ }

}, []);

function saveToday() { const key = todayKey(); const record: SavedRecord = { date: key, savedAt: nowIso(), breed, count, feeders, age, intakePerBirdG, totalIntakeKg, schedule, note, }; try { const raw = localStorage.getItem(LS_KEY); const data: Store = raw ? JSON.parse(raw) : { records: {}, lastSave: null };

data.records[key] = record;
  data.lastSave = key;
  localStorage.setItem(LS_KEY, JSON.stringify(data));
  setLastSave(key);

  // refrescar AYER y lista
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yKey = yesterday.toISOString().slice(0,10);
  setYesterdayRecord(data.records[yKey] || null);
  setSavedList(Object.values(data.records).sort((a,b)=> a.date < b.date ? 1 : -1));

  alert("‚úÖ Registro guardado.");
} catch {
  alert("No se pudo guardar el registro (modo privado del navegador o sin almacenamiento disponible).");
}

}

function loadSaved(key: string) { try { const raw = localStorage.getItem(LS_KEY); if (!raw) return; const data: Store = JSON.parse(raw); const rec = data.records[key]; if (!rec) return; setSelectedKey(key); setBreed(rec.breed); setCount(rec.count); setFeeders(rec.feeders || 8); setAge(rec.age); setNote(rec.note || ""); } catch { /* noop */ } }

async function shareCurrent() { const url = buildShareUrl({ breed, count, age, feeders, note }); try { if (navigator.share) { await navigator.share({ title: "Allpa ¬∑ Calculadora de raciones", text: "Consulta de raciones precargada", url }); } else { await navigator.clipboard.writeText(url); alert("üîó Enlace copiado al portapapeles"); } } catch { /* cancel */ } }

return ( <div className="min-h-screen bg-neutral-50 text-neutral-900"> {/* Header en tonos verdes */} <div className="w-full bg-gradient-to-r from-emerald-800 via-emerald-700 to-emerald-500 text-white"> <header className="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between"> <h1 className="text-xl sm:text-2xl font-bold tracking-tight">Allpa ¬∑ Calculadora diaria de raciones</h1> <button onClick={shareCurrent} className="rounded-xl bg-white/10 hover:bg-white/20 px-3 py-1.5 text-sm">Compartir</button> </header> </div>

{/* Main */}
  <main className="max-w-5xl mx-auto px-4 py-6 grid gap-6">
    {/* Formulario */}
    <section className="rounded-2xl border bg-white p-4 md:p-6 grid gap-4">
      <div className="flex items-center justify-between flex-wrap gap-3">
        <h2 className="text-lg font-semibold">Datos del lote</h2>
        {savedList.length > 0 && (
          <div className="flex items-center gap-2">
            <label className="text-sm">Cargar registro:</label>
            <select value={selectedKey} onChange={(e)=>loadSaved(e.target.value)} className="rounded-xl border px-3 py-2 text-sm">
              <option value="">Selecciona‚Ä¶</option>
              {savedList.map(rec => (
                <option key={rec.date} value={rec.date}>{rec.date} ¬∑ Edad {rec.age}d ¬∑ {rec.count} aves</option>
              ))}
            </select>
          </div>
        )}
      </div>

      <div className="grid sm:grid-cols-5 gap-4 items-center">
        <div className="sm:col-span-1">
          <label className="text-sm font-medium">Raza</label>
          <select value={breed} onChange={(e)=>setBreed(e.target.value)} className="mt-1 w-full rounded-xl border px-3 py-2">
            {BREEDS.map(b=> <option key={b.value} value={b.value}>{b.label}</option>)}
          </select>
        </div>
        <div className="sm:col-span-1">
          <label className="text-sm font-medium">Cantidad de pollos</label>
          <input type="number" min={1} value={count} onChange={(e)=>setCount(parseInt(e.target.value||'0'))} className="mt-1 w-full rounded-xl border px-3 py-2" />
        </div>
        <div className="sm:col-span-1">
          <label className="text-sm font-medium">Comederos</label>
          <input type="number" min={1} value={feeders} onChange={(e)=>setFeeders(Math.max(1, parseInt(e.target.value||'1')))} className="mt-1 w-full rounded-xl border px-3 py-2" />
        </div>
        <div className="sm:col-span-2">
          <label className="text-sm font-medium flex items-center justify-between">
            <span>Edad (d√≠as)</span>
            <span className="text-xs text-neutral-600">D√≠a seleccionado: <b>{age}</b>/56</span>
          </label>
          <input type="range" min={1} max={56} value={age} onChange={(e)=>setAge(parseInt(e.target.value||'1'))} className="mt-2 w-full" />
        </div>
      </div>
      <p className="text-sm text-neutral-600">Al guardar, se registran autom√°ticamente las observaciones y la hora para trazabilidad.</p>
    </section>

    {/* Resultados */}
    <section className="rounded-2xl border bg-white p-4 md:p-6 grid gap-6">
      <h2 className="text-lg font-semibold">Resultados de hoy</h2>
      <div className="grid md:grid-cols-2 gap-4">
        <Stat label="Consumo recomendado (g/ave/d√≠a)" value={`${intakePerBirdG.toLocaleString()} g`} />
        <Stat label="Total de alimento (kg/d√≠a)" value={`${totalIntakeKg.toFixed(2)} kg`} />
      </div>

      <div className="rounded-xl border p-4">
        <p className="font-medium mb-2">Horario recomendado</p>
        <p className="text-sm text-neutral-700 mb-3">{schedule.summary}</p>
        {schedule.mode !== 'adlib' ? (
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left text-neutral-600">
                <th className="py-1">Raci√≥n</th>
                <th className="py-1">g/ave</th>
                <th className="py-1">kg total</th>
                <th className="py-1">kg/comedero</th>
                <th className="py-1">aves/comedero</th>
              </tr>
            </thead>
            <tbody>
              {rations.map((r, idx)=> (
                <tr key={idx} className="border-t">
                  <td className="py-1">{r.label}</td>
                  <td className="py-1">{r.perBirdG}</td>
                  <td className="py-1">{r.totalKg}</td>
                  <td className="py-1">{r.perFeederKg}</td>
                  <td className="py-1">{birdsPerFeeder}</td>
                </tr>
              ))}
            </tbody>
          </table>
        ) : (
          <div className="text-sm text-neutral-700">Asegura comederos disponibles las 24 horas. Cambia el alimento frecuentemente para mantenerlo fresco.</div>
        )}
      </div>

      {/* Notas y guardado */}
      <div className="grid md:grid-cols-2 gap-4 items-start">
        <div>
          <label className="text-sm font-medium">Observaciones de hoy</label>
          <textarea value={note} onChange={(e)=>setNote(e.target.value)} rows={4} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Ej.: consumo bajo por calor al mediod√≠a, mejorar ventilaci√≥n" />
        </div>
        <div className="rounded-xl border p-4 grid gap-3">
          <button onClick={saveToday} className="w-full rounded-xl bg-emerald-600 text-white py-2 font-medium hover:bg-emerald-700 transition">üíæ Guardar registro de hoy</button>
          <p className="text-xs text-neutral-600">√öltimo guardado: {lastSave || "‚Äî"}</p>
          {yesterdayRecord && (
            <div className="text-sm bg-neutral-50 rounded-lg border p-3">
              <p className="font-medium mb-1">Ayer ({yesterdayRecord.date})</p>
              <ul className="text-xs list-disc ml-4 space-y-1">
                <li>Edad: {yesterdayRecord.age} d√≠as</li>
                <li>Consumo: {yesterdayRecord.intakePerBirdG} g/ave/d√≠a</li>
                <li>Total alimento: {Number(yesterdayRecord.totalIntakeKg).toFixed(2)} kg</li>
              </ul>
            </div>
          )}
        </div>
      </div>
    </section>

    {/* Buenas pr√°cticas (colapsable) */}
    <section className="rounded-2xl border bg-white p-4 md:p-6">
      <details>
        <summary className="cursor-pointer select-none text-lg font-semibold">Buenas pr√°cticas r√°pidas</summary>
        <ul className="mt-3 text-sm space-y-2 list-disc ml-5 text-neutral-700">
          <li>En d√≠as 3‚Äì5, usa raciones peque√±as y frecuentes para estimular el consumo.</li>
          <li>En climas c√°lidos, prioriza mayor % de la raci√≥n en la ma√±ana.</li>
          <li>Revisa a diario ventilaci√≥n, cama, agua y comportamiento.</li>
          <li>Pesa una muestra de aves semanalmente para validar el peso real vs esperado.</li>
        </ul>
      </details>
    </section>
  </main>
</div>

); }

function Stat({ label, value }: { label: string, value: string }) { return ( <div className="rounded-xl border p-4 bg-neutral-50"> <p className="text-xs uppercase tracking-wide text-neutral-600">{label}</p> <p className="text-xl font-semibold">{value}</p> </div> ); }

function buildShareUrl({ breed, count, age, feeders, note }: { breed: string; count: number; age: number; feeders: number; note?: string; }) { const base = ${window.location.origin}${window.location.pathname}; const params = new URLSearchParams(); params.set("breed", String(breed)); params.set("count", String(count)); params.set("age", String(age)); params.set("feeders", String(feeders)); if (note) params.set("note", note); return ${base}?${params.toString()}; }