import React, { useEffect, useMemo, useState } from "react";

/**
 * Allpa ‚Äì Calculadora diaria de raciones para pollos (v3)
 * Cambios de esta versi√≥n:
 * - Header: degradado SOLO en tonos verdes (sin √°mbar).
 * - Bot√≥n "Compartir" que genera URL con datos precargados (breed, count, age, note opcional) y usa Web Share API o copia al portapapeles.
 * - Al cargar: si hay par√°metros en la URL, se precargan autom√°ticamente.
 * - Lista desplegable de registros guardados (si existen) para cargar datos hist√≥ricos al formulario.
 * - Mantiene trazabilidad de visitas/guardados.
 * - 6 raciones solo hasta d√≠a 5; desde d√≠a 6, 2 raciones.
 * - Slider de d√≠as 1‚Äì56.
 */

// --- Utilidades ---
function lerp(a: number, b: number, t: number) { return a + (b - a) * t; }
function piecewiseLinear(age: number, points: Array<[number, number]>) {
  if (age <= points[0][0]) return points[0][1];
  if (age >= points[points.length - 1][0]) return points[points.length - 1][1];
  for (let i = 0; i < points.length - 1; i++) {
    const [aX, aY] = points[i];
    const [bX, bY] = points[i + 1];
    if (age >= aX && age <= bX) {
      const t = (age - aX) / (bX - aX);
      return lerp(aY, bY, t);
    }
  }
  return points[points.length - 1][1];
}
const nowIso = () => new Date().toISOString();
const todayKey = () => new Date().toISOString().slice(0,10);

// --- Curvas base (aprox. orientativas) ---
const WEIGHT_CURVE_POINTS: Array<[number, number]> = [
  [1, 42], [7, 180], [14, 450], [21, 900], [28, 1500], [35, 2200], [42, 2900], [56, 3600]
];
const INTAKE_CURVE_POINTS: Array<[number, number]> = [
  [1, 12], [2, 18], [5, 30], [7, 40], [14, 75], [21, 110], [28, 150], [35, 180], [42, 200], [56, 225]
];

// Etapas por edad
function feedStage(age: number) {
  if (age <= 7) return { code: "preiniciador", label: "Preiniciador (d√≠as 1‚Äì7)" };
  if (age <= 21) return { code: "iniciador", label: "Iniciador (d√≠as 8‚Äì21)" };
  if (age <= 35) return { code: "crecimiento", label: "Crecimiento (d√≠as 22‚Äì35)" };
  return { code: "finalizador", label: "Finalizador (d√≠as 36‚Äì56)" };
}

// Consejos
const TIPS = [
  "Mant√©n el agua entre 18‚Äì22 ¬∞C y limpia: el agua sucia baja el consumo.",
  "Revisa la cama: humedad ideal 20‚Äì25%. Si huele a amon√≠aco, ventila.",
  "Altura del comedero: a nivel del dorso del pollo para evitar desperdicio.",
  "Eval√∫a temperatura del galp√≥n por comportamiento, no solo por term√≥metro.",
  "Pesa 10 aves al azar para validar el promedio de peso.",
  "Registra mortalidad y causas para detectar patrones tempranos.",
];

// Razas
const BREEDS = [
  { value: "cobb500", label: "Cobb 500" },
  { value: "ross308", label: "Ross 308" },
  { value: "hubbard", label: "Hubbard" },
  { value: "otra", label: "Otra / mi l√≠nea" },
];

// Horarios
type Schedule = { mode: "adlib" | "six" | "two"; summary: string; details: string[] };
function scheduleForAge(age: number): Schedule {
  if (age <= 2) {
    return { mode: "adlib", summary: "D√≠as 1‚Äì2: alimentaci√≥n a voluntad (24/7)", details: ["Comederos siempre llenos y accesibles."] };
  }
  if (age <= 5) {
    return { mode: "six", summary: "D√≠as 3‚Äì5: 6 raciones peque√±as para estimular consumo", details: ["6:00","9:00","12:00","15:00","17:00","19:00"] };
  }
  return { mode: "two", summary: "Desde d√≠a 6: 2 raciones (ma√±ana y tarde)", details: ["6:00 (Raci√≥n 1)","17:00 (Raci√≥n 2)"] };
}

// Persistencia
const LS_KEY = "allpa_calc_raciones_v3"; // nueva versi√≥n para compatibilidad

type SavedRecord = {
  date: string;
  savedAt: string;
  breed: string;
  count: number;
  age: number;
  intakePerBirdG: number;
  expectedWeightG: number;
  totalIntakeKg: number;
  stage: any;
  schedule: any;
  note?: string;
  rations: Array<{ label: string; perBirdG: string; totalKg: string }>;
};

type Store = {
  records: Record<string, SavedRecord>;
  streak: number;
  lastSave: string | null;
  visits: Array<{ at: string; action: "visit" | "save" }>;
};

export default function Page() {
  const [breed, setBreed] = useState("cobb500");
  const [count, setCount] = useState<number>(100);
  const [age, setAge] = useState<number>(1);
  const [note, setNote] = useState("");
  const [streak, setStreak] = useState(0);
  const [lastSave, setLastSave] = useState<string | null>(null);
  const [yesterdayRecord, setYesterdayRecord] = useState<SavedRecord | null>(null);
  const [savedList, setSavedList] = useState<Array<SavedRecord>>([]);
  const [selectedKey, setSelectedKey] = useState<string>("");

  // Tip del d√≠a
  const tipOfDay = useMemo(() => {
    const idx = Math.abs(hashCode(todayKey())) % TIPS.length;
    return TIPS[idx];
  }, []);

  // Derivados
  const schedule = useMemo(() => scheduleForAge(age), [age]);
  const intakePerBirdG = useMemo(() => Math.round(piecewiseLinear(age, INTAKE_CURVE_POINTS)), [age]);
  const expectedWeightG = useMemo(() => Math.round(piecewiseLinear(age, WEIGHT_CURVE_POINTS)), [age]);
  const totalIntakeKg = useMemo(() => ((intakePerBirdG * count) / 1000), [intakePerBirdG, count]);
  const stage = useMemo(() => feedStage(age), [age]);

  // Raciones por horario
  const rations = useMemo(() => {
    if (schedule.mode === "adlib") return [] as Array<{ label: string, perBirdG: string, totalKg: string }>;
    if (schedule.mode === "six") {
      const per = intakePerBirdG / 6;
      return schedule.details.map((d) => ({ label: d, perBirdG: formatG(per), totalKg: formatKg(per * count) }));
    }
    const r1 = Math.round(intakePerBirdG * 0.6);
    const r2 = intakePerBirdG - r1;
    return [
      { label: schedule.details[0], perBirdG: formatG(r1), totalKg: formatKg(r1 * count) },
      { label: schedule.details[1], perBirdG: formatG(r2), totalKg: formatKg(r2 * count) },
    ];
  }, [schedule, intakePerBirdG, count]);

  // Al cargar: leer store, registrar visita, precargar por URL y preparar lista de registros
  useEffect(() => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      const data: Store = raw ? JSON.parse(raw) : { records: {}, streak: 0, lastSave: null, visits: [] };

      // registrar visita
      data.visits = Array.isArray(data.visits) ? data.visits : [];
      data.visits.push({ at: nowIso(), action: "visit" });

      // streak + lastSave al state
      setStreak(data.streak || 0);
      setLastSave(data.lastSave || null);

      // cargar AYER
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yKey = yesterday.toISOString().slice(0,10);
      if (data.records && data.records[yKey]) setYesterdayRecord(data.records[yKey]);

      // cargar lista guardada
      const list = Object.values(data.records).sort((a,b)=> a.date < b.date ? 1 : -1);
      setSavedList(list);

      // precargar por URL
      const params = new URLSearchParams(window.location.search);
      const qBreed = params.get("breed");
      const qCount = params.get("count");
      const qAge = params.get("age");
      const qNote = params.get("note");
      if (qBreed) setBreed(qBreed);
      if (qCount && !isNaN(parseInt(qCount))) setCount(parseInt(qCount));
      if (qAge && !isNaN(parseInt(qAge))) setAge(Math.max(1, Math.min(56, parseInt(qAge))));
      if (qNote) setNote(qNote);

      // guardar trazabilidad
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    } catch { /* noop */ }
  }, []);

  function saveToday() {
    const key = todayKey();
    const record: SavedRecord = {
      date: key,
      savedAt: nowIso(),
      breed, count, age,
      intakePerBirdG, expectedWeightG, totalIntakeKg,
      stage, schedule, note,
      rations,
    };
    try {
      const raw = localStorage.getItem(LS_KEY);
      const data: Store = raw ? JSON.parse(raw) : { records: {}, streak: 0, lastSave: null, visits: [] };

      // streak
      let newStreak = data.streak || 0;
      const prev = data.lastSave;
      if (prev === key) newStreak = data.streak || 1; else {
        if (prev) {
          const prevDate = new Date(prev);
          const y = new Date(key); y.setDate(y.getDate() - 1);
          if (prevDate.toISOString().slice(0,10) === y.toISOString().slice(0,10)) newStreak = (data.streak || 0) + 1; else newStreak = 1;
        } else newStreak = 1;
      }

      data.records[key] = record;
      data.streak = newStreak;
      data.lastSave = key;

      // trazabilidad de guardado
      data.visits = Array.isArray(data.visits) ? data.visits : [];
      data.visits.push({ at: nowIso(), action: "save" });

      localStorage.setItem(LS_KEY, JSON.stringify(data));
      setStreak(newStreak);
      setLastSave(key);

      // refrescar AYER y lista
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yKey = yesterday.toISOString().slice(0,10);
      setYesterdayRecord(data.records[yKey] || null);
      setSavedList(Object.values(data.records).sort((a,b)=> a.date < b.date ? 1 : -1));

      alert("‚úÖ Registro guardado. ¬°Sigue tu racha diaria!");
    } catch {
      alert("No se pudo guardar el registro (modo privado del navegador o sin almacenamiento disponible).");
    }
  }

  function loadSaved(key: string) {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const data: Store = JSON.parse(raw);
      const rec = data.records[key];
      if (!rec) return;
      setSelectedKey(key);
      setBreed(rec.breed);
      setCount(rec.count);
      setAge(rec.age);
      setNote(rec.note || "");
    } catch { /* noop */ }
  }

  async function shareCurrent() {
    const url = buildShareUrl({ breed, count, age, note });
    try {
      if (navigator.share) {
        await navigator.share({ title: "Allpa ¬∑ Calculadora de raciones", text: "Consulta de raciones precargada", url });
      } else {
        await navigator.clipboard.writeText(url);
        alert("üîó Enlace copiado al portapapeles");
      }
    } catch {
      // Ignorar cancelaciones
    }
  }

  return (
    <div className="min-h-screen bg-neutral-50 text-neutral-900">
      {/* Header con look Allpa: solo verdes */}
      <div className="w-full bg-gradient-to-r from-emerald-800 via-emerald-700 to-emerald-500 text-white">
        <header className="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
          <h1 className="text-xl sm:text-2xl font-bold tracking-tight">Allpa ¬∑ Calculadora diaria de raciones</h1>
          <div className="flex items-center gap-2">
            <button onClick={shareCurrent} className="rounded-xl bg-white/10 hover:bg-white/20 px-3 py-1.5 text-sm">Compartir</button>
            <div className="text-sm">Racha: <span className="font-semibold">{streak} d√≠a{streak===1?'':'s'}</span></div>
          </div>
        </header>
      </div>

      {/* Main */}
      <main className="max-w-5xl mx-auto px-4 py-6 grid gap-6">
        {/* Formulario */}
        <section className="rounded-2xl border bg-white p-4 md:p-6 grid gap-4">
          <div className="flex items-center justify-between flex-wrap gap-3">
            <h2 className="text-lg font-semibold">Datos del lote</h2>
            {savedList.length > 0 && (
              <div className="flex items-center gap-2">
                <label className="text-sm">Cargar registro:</label>
                <select value={selectedKey} onChange={(e)=>loadSaved(e.target.value)} className="rounded-xl border px-3 py-2 text-sm">
                  <option value="">Selecciona‚Ä¶</option>
                  {savedList.map(rec => (
                    <option key={rec.date} value={rec.date}>{rec.date} ¬∑ Edad {rec.age}d ¬∑ {rec.count} aves</option>
                  ))}
                </select>
              </div>
            )}
          </div>

          <div className="grid sm:grid-cols-4 gap-4 items-center">
            <div className="sm:col-span-1">
              <label className="text-sm font-medium">Raza</label>
              <select value={breed} onChange={(e)=>setBreed(e.target.value)} className="mt-1 w-full rounded-xl border px-3 py-2">
                {BREEDS.map(b=> <option key={b.value} value={b.value}>{b.label}</option>)}
              </select>
            </div>
            <div className="sm:col-span-1">
              <label className="text-sm font-medium">Cantidad de pollos</label>
              <input type="number" min={1} value={count} onChange={(e)=>setCount(parseInt(e.target.value||'0'))} className="mt-1 w-full rounded-xl border px-3 py-2" />
            </div>
            <div className="sm:col-span-2">
              <label className="text-sm font-medium flex items-center justify-between">
                <span>Edad (d√≠as)</span>
                <span className="text-xs text-neutral-600">D√≠a seleccionado: <b>{age}</b>/56</span>
              </label>
              <input type="range" min={1} max={56} value={age} onChange={(e)=>setAge(parseInt(e.target.value||'1'))} className="mt-2 w-full" />
            </div>
          </div>
          <p className="text-sm text-neutral-600">Usa la calculadora a diario: al guardar, tus observaciones y la hora quedan registradas autom√°ticamente para trazabilidad.</p>
        </section>

        {/* Resultados */}
        <section className="rounded-2xl border bg-white p-4 md:p-6 grid gap-6">
          <h2 className="text-lg font-semibold">Resultados de hoy</h2>
          <div className="grid md:grid-cols-3 gap-4">
            <Stat label="Peso esperado hoy (g/ave)" value={`${expectedWeightG.toLocaleString()} g`} />
            <Stat label="Consumo recomendado (g/ave/d√≠a)" value={`${intakePerBirdG.toLocaleString()} g`} />
            <Stat label="Total de alimento (kg/d√≠a)" value={`${totalIntakeKg.toFixed(2)} kg`} />
          </div>

          <div className="grid lg:grid-cols-2 gap-6">
            {/* Horario y raciones */}
            <div className="rounded-xl border p-4">
              <p className="font-medium mb-2">Horario recomendado</p>
              <p className="text-sm text-neutral-700 mb-3">{schedule.summary}</p>
              {schedule.mode !== 'adlib' ? (
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-left text-neutral-600">
                      <th className="py-1">Raci√≥n</th>
                      <th className="py-1">g/ave</th>
                      <th className="py-1">kg total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {rations.map((r, idx)=> (
                      <tr key={idx} className="border-t">
                        <td className="py-1">{r.label}</td>
                        <td className="py-1">{r.perBirdG}</td>
                        <td className="py-1">{r.totalKg}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              ) : (
                <div className="text-sm text-neutral-700">Asegura comederos disponibles las 24 horas. Cambia el alimento frecuentemente para mantenerlo fresco.</div>
              )}
            </div>

            {/* Tipo de alimento y consejo */}
            <div className="rounded-xl border p-4 grid gap-3">
              <div>
                <p className="font-medium">Tipo de alimento para hoy</p>
                <p className="text-sm text-neutral-700">{stage.label}</p>
              </div>
              <div>
                <p className="font-medium">Consejo del d√≠a</p>
                <p className="text-sm text-neutral-700">üí° {tipOfDay}</p>
              </div>
              <div>
                <p className="font-medium">Progreso del ciclo</p>
                <Progress value={(age/56)*100} />
                <p className="text-xs text-neutral-600 mt-1">D√≠a {age} de 56</p>
              </div>
            </div>
          </div>

          {/* Notas y guardado */}
          <div className="grid md:grid-cols-2 gap-4 items-start">
            <div>
              <label className="text-sm font-medium">Observaciones de hoy</label>
              <textarea value={note} onChange={(e)=>setNote(e.target.value)} rows={4} className="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Ej.: consumo bajo por calor al mediod√≠a, mejorar ventilaci√≥n" />
            </div>
            <div className="rounded-xl border p-4 grid gap-3">
              <button onClick={saveToday} className="w-full rounded-xl bg-emerald-600 text-white py-2 font-medium hover:bg-emerald-700 transition">üíæ Guardar registro de hoy</button>
              <p className="text-xs text-neutral-600">√öltimo guardado: {lastSave || "‚Äî"}</p>
              {yesterdayRecord && (
                <div className="text-sm bg-neutral-50 rounded-lg border p-3">
                  <p className="font-medium mb-1">Ayer ({yesterdayRecord.date})</p>
                  <ul className="text-xs list-disc ml-4 space-y-1">
                    <li>Edad: {yesterdayRecord.age} d√≠as</li>
                    <li>Peso esperado: {yesterdayRecord.expectedWeightG} g</li>
                    <li>Consumo: {yesterdayRecord.intakePerBirdG} g/ave/d√≠a</li>
                    <li>Total alimento: {Number(yesterdayRecord.totalIntakeKg).toFixed(2)} kg</li>
                  </ul>
                </div>
              )}
            </div>
          </div>
        </section>

        {/* Buenas pr√°cticas */}
        <section className="rounded-2xl border bg-white p-4 md:p-6">
          <h2 className="text-lg font-semibold mb-3">Buenas pr√°cticas r√°pidas</h2>
          <ul className="text-sm space-y-2 list-disc ml-5 text-neutral-700">
            <li>En d√≠as 3‚Äì5, usa raciones peque√±as y frecuentes para estimular el consumo.</li>
            <li>En climas c√°lidos, prioriza mayor % de la raci√≥n en la ma√±ana.</li>
            <li>Revisa a diario ventilaci√≥n, cama, agua y comportamiento.</li>
            <li>Pesa una muestra de aves semanalmente para validar el peso real vs esperado.</li>
          </ul>
        </section>
      </main>


    </div>
  );
}

function Stat({ label, value }: { label: string, value: string }) {
  return (
    <div className="rounded-xl border p-4 bg-neutral-50">
      <p className="text-xs uppercase tracking-wide text-neutral-600">{label}</p>
      <p className="text-xl font-semibold">{value}</p>
    </div>
  );
}

function Progress({ value }: { value: number }) {
  return (
    <div className="w-full h-3 bg-neutral-200 rounded-full overflow-hidden">
      <div className="h-full bg-emerald-600" style={{ width: `${Math.max(0, Math.min(100, value))}%` }} />
    </div>
  );
}

// Helpers
function formatG(v: number) { return `${Math.round(v)} g`; }
function formatKg(v: number) { return `${(v/1000).toFixed(2)} kg`; }
function hashCode(str: string) { let h = 0; for (let i=0;i<str.length;i++){ h = ((h<<5)-h)+str.charCodeAt(i); h|=0; } return h; }
function buildShareUrl({ breed, count, age, note }: { breed: string; count: number; age: number; note?: string; }) {
  const base = `${window.location.origin}${window.location.pathname}`;
  const params = new URLSearchParams();
  params.set("breed", String(breed));
  params.set("count", String(count));
  params.set("age", String(age));
  if (note) params.set("note", note);
  return `${base}?${params.toString()}`;
}
