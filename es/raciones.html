<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allpa ¬∑ Calculadora diaria de raciones</title>
  <meta name="description" content="Calculadora de raciones diarias para pollos ‚Äì Allpa" />
  <style>
    :root{
      --emerald-800:#065f46; --emerald-700:#047857; --emerald-500:#10b981;
      --neutral-50:#fafafa; --neutral-200:#e5e5e5; --neutral-600:#525252; --neutral-700:#404040; --neutral-900:#171717;
      --white:#fff; --black:#000;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;color:var(--neutral-900);background:var(--neutral-50)}
    .container{max-width:960px;margin:0 auto;padding:24px}
    header{color:var(--white);background:linear-gradient(90deg,var(--emerald-800),var(--emerald-700),var(--emerald-500));}
    header .wrap{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    h1{margin:0;font-size:22px;font-weight:700}
    .btn{display:inline-flex;align-items:center;gap:8px;border-radius:12px;border:1px solid transparent;padding:8px 12px;font-size:14px;cursor:pointer}
    .btn-share{background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.2)}
    .btn-share:hover{background:rgba(255,255,255,.2)}
    .card{background:#fff;border:1px solid var(--neutral-200);border-radius:16px;padding:16px}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:1fr;}
    .grid-3{grid-template-columns:1fr;}
    @media(min-width:768px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:repeat(3,1fr)}}
    label{font-size:14px;font-weight:600}
    input[type="number"],select,textarea{width:100%;border:1px solid var(--neutral-200);border-radius:12px;padding:8px 10px;margin-top:6px;font-size:14px}
    input[type="range"]{width:100%}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 6px;border-top:1px solid var(--neutral-200);text-align:left}
    .stat{background:#f5f5f5;border:1px solid var(--neutral-200);border-radius:12px;padding:12px}
    .stat .k{font-size:12px;letter-spacing:.06em;color:var(--neutral-600);text-transform:uppercase}
    .stat .v{font-size:18px;font-weight:700}
    .progress{height:10px;border-radius:999px;background:#e5e5e5;overflow:hidden}
    .progress > span{display:block;height:100%;background:var(--emerald-600,#059669);width:0}
    .text-xs{font-size:12px;color:var(--neutral-600)}
    footer.magnet{position:fixed;left:0;right:0;bottom:0;padding:16px}
    .magnet .bar{max-width:960px;margin:0 auto;background:#fff;border:1px solid var(--neutral-200);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .magnet .bar .inner{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .btn-prim{background:var(--black);color:#fff}
    .btn-sec{background:#fff;border-color:var(--neutral-200)}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Allpa ¬∑ Calculadora diaria de raciones</h1>
      <div style="display:flex;align-items:center;gap:8px">
        <button id="btnShare" class="btn btn-share">Compartir</button>
        <div class="text-xs">Racha: <b id="streak">0</b> d√≠a(s)</div>
      </div>
    </div>
  </header>

  <main class="container grid" style="padding-bottom:120px">
    <!-- Datos del lote -->
    <section class="card grid">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <h2 style="margin:0;font-size:18px">Datos del lote</h2>
        <div id="savedWrap" class="hidden" style="display:flex;align-items:center;gap:8px">
          <label class="text-xs" for="savedSelect">Cargar registro:</label>
          <select id="savedSelect"></select>
        </div>
      </div>

      <div class="grid" style="grid-template-columns:1fr;gap:16px">
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px">
          <div>
            <label>Raza</label>
            <select id="breed">
              <option value="cobb500">Cobb 500</option>
              <option value="ross308">Ross 308</option>
              <option value="hubbard">Hubbard</option>
              <option value="otra">Otra / mi l√≠nea</option>
            </select>
          </div>
          <div>
            <label>Cantidad de pollos</label>
            <input id="count" type="number" min="1" value="100" />
          </div>
        </div>
        <div>
          <label style="display:flex;align-items:center;justify-content:space-between">
            <span>Edad (d√≠as)</span>
            <span class="text-xs">D√≠a seleccionado: <b id="ageLabel">1</b>/56</span>
          </label>
          <input id="age" type="range" min="1" max="56" value="1" />
        </div>
        <p class="text-xs">Usa la calculadora a diario: tus observaciones y la hora quedan registradas autom√°ticamente para trazabilidad.</p>
      </div>
    </section>

    <!-- Resultados -->
    <section class="card grid">
      <h2 style="margin:0;font-size:18px">Resultados de hoy</h2>
      <div class="grid grid-3">
        <div class="stat"><div class="k">Peso esperado hoy (g/ave)</div><div class="v" id="statWeight">0 g</div></div>
        <div class="stat"><div class="k">Consumo recomendado (g/ave/d√≠a)</div><div class="v" id="statIntake">0 g</div></div>
        <div class="stat"><div class="k">Total de alimento (kg/d√≠a)</div><div class="v" id="statTotal">0 kg</div></div>
      </div>

      <div class="grid grid-2">
        <div class="card" style="padding:12px">
          <p style="margin:.2rem 0;font-weight:600">Horario recomendado</p>
          <p id="scheduleSummary" class="text-xs" style="margin:.2rem 0 8px"></p>
          <div id="scheduleTableWrap"></div>
        </div>

        <div class="card" style="padding:12px">
          <div style="margin-bottom:8px">
            <p style="margin:.2rem 0;font-weight:600">Tipo de alimento para hoy</p>
            <p id="feedStage" class="text-xs" style="margin:.2rem 0"></p>
          </div>
          <div style="margin-bottom:8px">
            <p style="margin:.2rem 0;font-weight:600">Consejo del d√≠a</p>
            <p id="tip" class="text-xs" style="margin:.2rem 0"></p>
          </div>
          <div>
            <p style="margin:.2rem 0;font-weight:600">Progreso del ciclo</p>
            <div class="progress"><span id="progressBar"></span></div>
            <p class="text-xs" id="progressText" style="margin:.2rem 0"></p>
          </div>
        </div>
      </div>

      <div class="grid grid-2">
        <div>
          <label>Observaciones de hoy</label>
          <textarea id="note" rows="4" placeholder="Ej.: consumo bajo por calor al mediod√≠a, mejorar ventilaci√≥n"></textarea>
        </div>
        <div class="card" style="padding:12px">
          <button id="btnSave" class="btn btn-prim" style="width:100%">üíæ Guardar registro de hoy</button>
          <p class="text-xs" id="lastSaveText" style="margin-top:8px">√öltimo guardado: ‚Äî</p>
          <div id="yesterdayWrap" class="hidden" style="margin-top:8px">
            <p style="margin:.2rem 0;font-weight:600">Ayer (<span id="yesterdayDate"></span>)</p>
            <ul class="text-xs" style="margin:.2rem 0 0 1rem">
              <li>Edad: <span id="yAge"></span> d√≠as</li>
              <li>Peso esperado: <span id="yWeight"></span> g</li>
              <li>Consumo: <span id="yIntake"></span> g/ave/d√≠a</li>
              <li>Total alimento: <span id="yTotal"></span> kg</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Buenas pr√°cticas -->
    <section class="card">
      <h2 style="margin:0 0 8px;font-size:18px">Buenas pr√°cticas r√°pidas</h2>
      <ul class="text-xs" style="margin:.2rem 0 0 1rem;line-height:1.6">
        <li>En d√≠as 3‚Äì5, usa raciones peque√±as y frecuentes para estimular el consumo.</li>
        <li>En climas c√°lidos, prioriza mayor % de la raci√≥n en la ma√±ana.</li>
        <li>Revisa a diario ventilaci√≥n, cama, agua y comportamiento.</li>
        <li>Pesa una muestra de aves semanalmente para validar el peso real vs esperado.</li>
      </ul>
    </section>
  </main>

  <!-- Footer magn√©tico -->
  <footer class="magnet">
    <div class="bar">
      <div class="inner">
        <div>
          <p style="margin:0;font-weight:600">¬øTe sirvi√≥ la calculadora?</p>
          <p class="text-xs" style="margin:2px 0 0">Sigue al Pollo Ingeniero y apoya el proyecto Allpa</p>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn btn-prim" href="#">S√≠guenos en TikTok</a>
          <a class="btn btn-sec" href="#">Donaciones (Nequi)</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Opci√≥n 1: JS externo en /js/app.js -->
  <script src="js/app.js"></script>

  <!-- Opci√≥n 2 (r√°pida): pegar el mismo JS ac√° si no vas a usar carpeta js
  <script>
    // Pega aqu√≠ el contenido de js/app.js si prefieres un √∫nico archivo HTML.
  </script>
  -->
</body>
</html>

<!-- ==================  Archivo: js/app.js  ================== -->
<script type="text/plain" data-filename="js/app.js">
(function(){
  // ===== Utilidades =====
  const $ = (sel)=>document.querySelector(sel);
  const nowIso = ()=>new Date().toISOString();
  const todayKey = ()=>new Date().toISOString().slice(0,10);
  function lerp(a,b,t){return a+(b-a)*t}
  function piecewiseLinear(age, points){
    if(age<=points[0][0]) return points[0][1];
    if(age>=points[points.length-1][0]) return points[points.length-1][1];
    for(let i=0;i<points.length-1;i++){
      const [ax,ay]=points[i], [bx,by]=points[i+1];
      if(age>=ax && age<=bx){ const t=(age-ax)/(bx-ax); return lerp(ay,by,t); }
    }
    return points[points.length-1][1];
  }
  function hashCode(str){let h=0;for(let i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i);h|=0}return h}
  function formatG(v){return `${Math.round(v)} g`}
  function formatKg(v){return `${(v/1000).toFixed(2)} kg`}

  // ===== Datos base =====
  const LS_KEY = 'allpa_calc_raciones_html_v1';
  const WEIGHT = [[1,42],[7,180],[14,450],[21,900],[28,1500],[35,2200],[42,2900],[56,3600]];
  const INTAKE = [[1,12],[2,18],[5,30],[7,40],[14,75],[21,110],[28,150],[35,180],[42,200],[56,225]];
  const TIPS = [
    'Mant√©n el agua entre 18‚Äì22 ¬∞C y limpia: el agua sucia baja el consumo.',
    'Revisa la cama: humedad ideal 20‚Äì25%. Si huele a amon√≠aco, ventila.',
    'Altura del comedero: a nivel del dorso del pollo para evitar desperdicio.',
    'Eval√∫a temperatura del galp√≥n por comportamiento, no solo por term√≥metro.',
    'Pesa 10 aves al azar para validar el promedio de peso.',
    'Registra mortalidad y causas para detectar patrones tempranos.',
  ];

  function feedStage(age){
    if(age<=7) return 'Preiniciador (d√≠as 1‚Äì7)';
    if(age<=21) return 'Iniciador (d√≠as 8‚Äì21)';
    if(age<=35) return 'Crecimiento (d√≠as 22‚Äì35)';
    return 'Finalizador (d√≠as 36‚Äì56)';
  }

  function scheduleForAge(age){
    if(age<=2) return {mode:'adlib', summary:'D√≠as 1‚Äì2: alimentaci√≥n a voluntad (24/7)', details:['Comederos siempre llenos y accesibles.']};
    if(age<=5) return {mode:'six', summary:'D√≠as 3‚Äì5: 6 raciones peque√±as para estimular consumo', details:['6:00','9:00','12:00','15:00','17:00','19:00']};
    return {mode:'two', summary:'Desde d√≠a 6: 2 raciones (ma√±ana y tarde)', details:['6:00 (Raci√≥n 1)','17:00 (Raci√≥n 2)']};
  }

  // ===== Estado (inputs) =====
  const breedEl = $('#breed');
  const countEl = $('#count');
  const ageEl = $('#age');
  const ageLabel = $('#ageLabel');
  const noteEl = $('#note');

  // ===== UI de salida =====
  const statWeight = $('#statWeight');
  const statIntake = $('#statIntake');
  const statTotal  = $('#statTotal');
  const scheduleSummary = $('#scheduleSummary');
  const scheduleTableWrap = $('#scheduleTableWrap');
  const feedStageEl = $('#feedStage');
  const tipEl = $('#tip');
  const progressBar = $('#progressBar');
  const progressText = $('#progressText');
  const lastSaveText = $('#lastSaveText');
  const streakEl = $('#streak');

  // Ayer
  const yWrap = $('#yesterdayWrap');
  const yDate = $('#yesterdayDate');
  const yAge = $('#yAge');
  const yWeight = $('#yWeight');
  const yIntake = $('#yIntake');
  const yTotal = $('#yTotal');

  // Guardados
  const savedWrap = $('#savedWrap');
  const savedSelect = $('#savedSelect');

  // Botones
  const btnSave = $('#btnSave');
  const btnShare = $('#btnShare');

  // ===== Store helpers =====
  function loadStore(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {records:{},streak:0,lastSave:null,visits:[]} }catch{return {records:{},streak:0,lastSave:null,visits:[]}}
  }
  function saveStore(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }

  // ===== Inicializaci√≥n =====
  function initFromURL(){
    const p = new URLSearchParams(location.search);
    const b = p.get('breed'); const c = p.get('count'); const a = p.get('age'); const n = p.get('note');
    if(b) breedEl.value = b;
    if(c && !isNaN(parseInt(c))) countEl.value = parseInt(c);
    if(a && !isNaN(parseInt(a))) { ageEl.value = Math.max(1,Math.min(56,parseInt(a))); ageLabel.textContent = ageEl.value; }
    if(n) noteEl.value = n;
  }

  function refreshSavedList(store){
    const keys = Object.keys(store.records).sort().reverse();
    if(keys.length===0){ savedWrap.classList.add('hidden'); return; }
    savedWrap.classList.remove('hidden');
    savedSelect.innerHTML = '<option value="">Selecciona‚Ä¶</option>' + keys.map(k=>{
      const r = store.records[k];
      return `<option value="${k}">${r.date} ¬∑ Edad ${r.age}d ¬∑ ${r.count} aves</option>`;
    }).join('');
  }

  function loadYesterday(store){
    const d = new Date(); d.setDate(d.getDate()-1); const yKey = d.toISOString().slice(0,10);
    const r = store.records[yKey];
    if(!r){ yWrap.classList.add('hidden'); return; }
    yWrap.classList.remove('hidden');
    yDate.textContent = r.date; yAge.textContent = r.age; yWeight.textContent = r.expectedWeightG; yIntake.textContent = r.intakePerBirdG; yTotal.textContent = Number(r.totalIntakeKg).toFixed(2);
  }

  function tipOfDay(){ const list=TIPS; const idx=Math.abs(hashCode(todayKey()))%list.length; return list[idx]; }

  function recalc(){
    const age = parseInt(ageEl.value || '1');
    const count = parseInt(countEl.value || '0');
    const intake = Math.round(piecewiseLinear(age, INTAKE));
    const weight = Math.round(piecewiseLinear(age, WEIGHT));
    const totalKg = (intake*count)/1000;

    statWeight.textContent = weight.toLocaleString('es-CO')+ ' g';
    statIntake.textContent = intake.toLocaleString('es-CO')+ ' g';
    statTotal.textContent = totalKg.toFixed(2) + ' kg';

    const sch = scheduleForAge(age);
    scheduleSummary.textContent = sch.summary;
    if(sch.mode==='adlib'){
      scheduleTableWrap.innerHTML = '<div class="text-xs">Asegura comederos disponibles las 24 horas. Cambia el alimento frecuentemente para mantenerlo fresco.</div>';
    } else {
      let rows='';
      if(sch.mode==='six'){
        const per = intake/6;
        rows = sch.details.map(d=>`<tr><td>${d}</td><td>${formatG(per)}</td><td>${formatKg(per*count)}</td></tr>`).join('');
      } else {
        const r1 = Math.round(intake*0.6), r2 = intake - r1;
        rows = `<tr><td>${sch.details[0]}</td><td>${formatG(r1)}</td><td>${formatKg(r1*count)}</td></tr>`+
               `<tr><td>${sch.details[1]}</td><td>${formatG(r2)}</td><td>${formatKg(r2*count)}</td></tr>`;
      }
      scheduleTableWrap.innerHTML = `<table><thead><tr><th>Raci√≥n</th><th>g/ave</th><th>kg total</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    feedStageEl.textContent = feedStage(age);
    tipEl.textContent = 'üí° ' + tipOfDay();
    const pct = (age/56)*100; $('#progressBar').style.width = pct+'%';
    progressText.textContent = `D√≠a ${age} de 56`;
  }

  function updateStreakAndVisits(store, action){
    store.visits = Array.isArray(store.visits)?store.visits:[];
    store.visits.push({at:nowIso(), action});
    saveStore(store);
  }

  function saveToday(){
    const store = loadStore();
    const key = todayKey();
    const age = parseInt(ageEl.value||'1');
    const count = parseInt(countEl.value||'0');
    const intake = Math.round(piecewiseLinear(age, INTAKE));
    const weight = Math.round(piecewiseLinear(age, WEIGHT));
    const totalKg = (intake*count)/1000;
    const sch = scheduleForAge(age);

    // streak
    let newStreak = store.streak || 0;
    const prev = store.lastSave;
    if(prev === key) newStreak = store.streak || 1; else {
      if(prev){
        const prevDate = new Date(prev); const y = new Date(key); y.setDate(y.getDate()-1);
        if(prevDate.toISOString().slice(0,10) === y.toISOString().slice(0,10)) newStreak = (store.streak||0)+1; else newStreak = 1;
      } else newStreak = 1;
    }

    store.records[key] = {
      date:key,
      savedAt: nowIso(),
      breed:breedEl.value,
      count,
      age,
      intakePerBirdG:intake,
      expectedWeightG:weight,
      totalIntakeKg: totalKg,
      stage: feedStage(age),
      schedule: sch,
      note: noteEl.value,
      rations: [] // se calcula al vuelo, no necesario guardar desglose
    };
    store.streak = newStreak; store.lastSave = key;
    updateStreakAndVisits(store, 'save');

    streakEl.textContent = newStreak;
    lastSaveText.textContent = '√öltimo guardado: ' + key;
    refreshSavedList(store);
    loadYesterday(store);
    alert('‚úÖ Registro guardado. ¬°Sigue tu racha diaria!');
  }

  function loadSaved(key){
    const store = loadStore(); const rec = store.records[key]; if(!rec) return;
    savedSelect.value = key;
    breedEl.value = rec.breed; countEl.value = rec.count; ageEl.value = rec.age; ageLabel.textContent = rec.age; noteEl.value = rec.note||'';
    recalc();
  }

  function buildShareUrl(){
    const base = location.origin + location.pathname;
    const p = new URLSearchParams();
    p.set('breed', breedEl.value);
    p.set('count', String(parseInt(countEl.value||'0')));
    p.set('age', String(parseInt(ageEl.value||'1')));
    if(noteEl.value) p.set('note', noteEl.value);
    return `${base}?${p.toString()}`;
  }

  async function share(){
    const url = buildShareUrl();
    try{
      if(navigator.share){ await navigator.share({title:'Allpa ¬∑ Calculadora de raciones', text:'Consulta de raciones precargada', url}); }
      else { await navigator.clipboard.writeText(url); alert('üîó Enlace copiado al portapapeles'); }
    }catch(e){ /* cancel */ }
  }

  // ===== Eventos =====
  ['input','change'].forEach(evt=>{
    ageEl.addEventListener(evt,()=>{ ageLabel.textContent = ageEl.value; recalc(); });
    countEl.addEventListener(evt,recalc);
    breedEl.addEventListener(evt,recalc);
    noteEl.addEventListener(evt,()=>{/* solo edici√≥n */});
  });
  btnSave.addEventListener('click', saveToday);
  btnShare.addEventListener('click', share);
  savedSelect.addEventListener('change', (e)=>{ if(savedSelect.value) loadSaved(savedSelect.value); });

  // ===== Arranque =====
  (function start(){
    const store = loadStore();
    // visita
    updateStreakAndVisits(store, 'visit');
    // precargar URL
    initFromURL();
    // nota del d√≠a si existe
    if(store.records[todayKey()] && store.records[todayKey()].note){ noteEl.value = store.records[todayKey()].note; }
    // UI
    streakEl.textContent = store.streak||0; lastSaveText.textContent = '√öltimo guardado: '+(store.lastSave||'‚Äî');
    refreshSavedList(store);
    loadYesterday(store);
    // c√°lculo inicial
    recalc();
  })();
})();
</script>
