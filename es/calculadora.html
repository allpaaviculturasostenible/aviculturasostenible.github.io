<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculadora de Inversi√≥n en Concentrado | ALLPA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
      }
      input[type="range"] {
        accent-color: #4f8a45;
      }
      summary::-webkit-details-marker {
        display: none;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: #e8f5e9;
        color: #2c6e2f;
        border-radius: 0.5rem;
        padding: 0.2rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <!-- HERO -->
    <section class="text-center py-10 bg-white shadow-sm">
      <h1 class="text-3xl font-semibold text-[#2c6e2f] mb-2">
        Calcula tu inversi√≥n en concentrado para pollos
      </h1>
      <p class="text-gray-600">
        Herramienta gratuita de ALLPA Agricultura 4.0 para nuevos productores.
      </p>
    </section>

    <!-- CALCULADORA -->
    <section class="max-w-6xl mx-auto bg-white p-6 mt-8 rounded-2xl shadow-md">
      <h2 class="text-2xl font-semibold text-[#4f8a45] mb-4 text-center">
        Calculadora Av√≠cola
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Cantidad de pollos -->
        <div>
          <label for="pollos" class="block mb-2 font-medium"
            >Cantidad de pollos</label
          >
          <input
            type="number"
            id="pollos"
            class="w-full border rounded-lg p-2"
            placeholder="Ej: 200"
            min="1"
          />
        </div>

        <!-- Duraci√≥n del ciclo -->
        <div class="md:col-span-2">
          <label class="block mb-2 font-medium"
            >Duraci√≥n del ciclo (d√≠as)</label
          >
          <div class="flex items-center gap-3">
            <span class="text-sm text-gray-600">28</span>
            <input
              type="range"
              id="dias"
              min="28"
              max="56"
              step="1"
              value="56"
              class="flex-1"
            />
            <span class="text-sm text-gray-600">56</span>
            <span
              id="diasVal"
              class="ml-2 inline-flex items-center justify-center px-2 h-8 rounded-md bg-green-50 text-[#2c6e2f] font-semibold"
              >56 d ¬∑ 8 sem</span
            >
          </div>
          <p class="text-xs text-gray-500 mt-1" id="faseHint">
            Fases por d√≠as (ajustables): Preinicio 1‚Äì11 ‚Üí Inicio 12‚Äì20 ‚Üí Engorde
            21‚Äì56.
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-4">
        <!-- Raza (Cobb primero) -->
        <div>
          <label for="raza" class="block mb-2 font-medium">Raza</label>
          <select id="raza" class="w-full border rounded-lg p-2">
            <option value="cobb">Cobb 500</option>
            <option value="ross">Ross 308</option>
          </select>
        </div>
        <!-- Bulto -->
        <div>
          <label for="bulto" class="block mb-2 font-medium"
            >Peso del bulto (kg)</label
          >
          <select id="bulto" class="w-full border rounded-lg p-2">
            <option value="40">40 kg</option>
            <option value="50">50 kg</option>
          </select>
        </div>
        <!-- Cambios de alimento (din√°micos) -->
        <div>
          <label class="block mb-2 font-medium">Cambio a Inicio (d√≠a)</label>
          <input
            type="range"
            id="cortePre"
            min="11"
            max="14"
            step="1"
            value="11"
            class="w-full"
          />
          <div class="text-xs text-gray-500 mt-1">
            Sugerido: 11‚Äì14 &nbsp;<span class="chip" id="chipPre"
              >predeterminado 11</span
            >
          </div>
        </div>
        <div>
          <label class="block mb-2 font-medium">Cambio a Engorde (d√≠a)</label>
          <input
            type="range"
            id="corteIni"
            min="18"
            max="28"
            step="1"
            value="19"
            class="w-full"
          />
          <div class="text-xs text-gray-500 mt-1">
            Sugerido: 18‚Äì28 &nbsp;<span class="chip" id="chipIni"
              >predeterminado 19</span
            >
          </div>
        </div>
        <div class="flex items-end">
          <!-- Mezcla eliminada por definici√≥n de negocio -->
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
        <div class="md:col-span-2 flex items-end gap-3">
          <button
            id="btnCalcular"
            class="w-full bg-[#4f8a45] text-white p-3 rounded-lg hover:bg-[#2c6e2f] transition"
          >
            Calcular
          </button>
          <button
            id="btnCompartir"
            class="hidden w-full bg-white border p-3 rounded-lg hover:bg-green-50 transition"
          >
            Copiar enlace
          </button>
        </div>
      </div>

      <!-- Mortalidad -->
      <details id="mortalityBox" class="mt-6 rounded-xl border p-4 bg-gray-50">
        <summary
          class="cursor-pointer font-semibold text-[#2c6e2f] flex items-center gap-2"
        >
          <span>üîª Mortalidad (opcional) ‚Äì N√∫mero de aves por semana</span>
        </summary>
        <p class="text-sm text-gray-600 mt-2">
          Ajusta el c√°lculo seg√∫n la cantidad de aves que permanecen cada
          semana. Si no haces cambios, asumimos que todas las semanas se
          mantiene la misma cantidad.
        </p>
        <div class="mt-3 overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500">
                <th class="py-2 pr-3">Semana</th>
                <th class="py-2 pr-3">D√≠as de la semana en el ciclo</th>
                <th class="py-2">Aves</th>
              </tr>
            </thead>
            <tbody id="mortalityRows"></tbody>
          </table>
        </div>
      </details>

      <!-- INFOGRAF√çA / RESULTADOS -->
      <div id="infografia" class="mt-8 hidden">
        <h3 class="text-xl font-semibold text-[#2c6e2f] mb-2 text-center">
          Distribuci√≥n por fases de alimento
        </h3>
        <p class="text-center text-sm text-gray-600 mb-4">
          Ajusta los <span class="font-semibold">precios por bulto</span> para
          refinar el c√°lculo. Los precios est√°n en COP.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- PREINICIO -->
          <div class="rounded-2xl border shadow-sm p-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-[#2c6e2f]">Preinicio</h4>
              <span
                id="preDias"
                class="text-xs bg-green-100 text-[#2c6e2f] px-2 py-1 rounded"
                >D√≠as 1‚Äì11</span
              >
            </div>
            <label class="text-sm text-gray-600">Precio (COP/bulto)</label>
            <div class="flex items-center gap-2 mb-3">
              <input
                id="precioPre"
                type="range"
                min="80000"
                max="180000"
                step="1000"
                value="120000"
                class="w-full"
              />
              <input
                id="precioPreNum"
                type="number"
                class="w-28 border rounded p-1"
                value="120000"
              />
            </div>
            <dl class="text-sm space-y-1">
              <div class="flex justify-between">
                <dt>Consumo (kg)</dt>
                <dd id="kgPre" class="font-medium">0</dd>
              </div>
              <div class="flex justify-between">
                <dt>Bultos</dt>
                <dd id="bagsPre" class="font-medium">0</dd>
              </div>
              <div class="flex justify-between">
                <dt>Subtotal</dt>
                <dd id="subtotalPre" class="font-semibold text-[#2c6e2f]">0</dd>
              </div>
            </dl>
          </div>

          <!-- INICIO -->
          <div class="rounded-2xl border shadow-sm p-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-[#2c6e2f]">Inicio</h4>
              <span
                id="iniDias"
                class="text-xs bg-green-100 text-[#2c6e2f] px-2 py-1 rounded"
                >D√≠as 12‚Äì20</span
              >
            </div>
            <label class="text-sm text-gray-600">Precio (COP/bulto)</label>
            <div class="flex items-center gap-2 mb-3">
              <input
                id="precioIni"
                type="range"
                min="80000"
                max="180000"
                step="1000"
                value="110000"
                class="w-full"
              />
              <input
                id="precioIniNum"
                type="number"
                class="w-28 border rounded p-1"
                value="110000"
              />
            </div>
            <dl class="text-sm space-y-1">
              <div class="flex justify-between">
                <dt>Consumo (kg)</dt>
                <dd id="kgIni" class="font-medium">0</dd>
              </div>
              <div class="flex justify-between">
                <dt>Bultos</dt>
                <dd id="bagsIni" class="font-medium">0</dd>
              </div>
              <div class="flex justify-between">
                <dt>Subtotal</dt>
                <dd id="subtotalIni" class="font-semibold text-[#2c6e2f]">0</dd>
              </div>
            </dl>
          </div>

          <!-- ENGORDE -->
          <div class="rounded-2xl border shadow-sm p-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-[#2c6e2f]">Engorde</h4>
              <span
                id="engDias"
                class="text-xs bg-green-100 text-[#2c6e2f] px-2 py-1 rounded"
                >D√≠as 21‚Äì56</span
              >
            </div>
            <label class="text-sm text-gray-600">Precio (COP/bulto)</label>
            <div class="flex items-center gap-2 mb-3">
              <input
                id="precioEng"
                type="range"
                min="80000"
                max="180000"
                step="1000"
                value="100000"
                class="w-full"
              />
              <input
                id="precioEngNum"
                type="number"
                class="w-28 border rounded p-1"
                value="100000"
              />
            </div>
            <dl class="text-sm space-y-1">
              <div class="flex justify-between">
                <dt>Consumo (kg)</dt>
                <dd id="kgEng" class="font-medium">0</dd>
              </div>
              <div class="flex justify-between">
                <dt>Bultos</dt>
                <dd id="bagsEng" class="font-medium">0</dd>
              </div>
              <div class="flex justify-between">
                <dt>Subtotal</dt>
                <dd id="subtotalEng" class="font-semibold text-[#2c6e2f]">0</dd>
              </div>
            </dl>
          </div>
        </div>

        <!-- Totales -->
        <div class="mt-6 bg-green-50 rounded-xl p-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-center">
            <div>
              <p class="text-sm text-gray-600">Consumo total (kg)</p>
              <p id="kgTotal" class="text-lg font-semibold">0</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Bultos totales</p>
              <p id="bagsTotal" class="text-lg font-semibold">0</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Inversi√≥n estimada (COP)</p>
              <p
                id="inversionTotal"
                class="text-xl font-extrabold text-[#2c6e2f]"
              >
                0
              </p>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-2 text-center">
            Notas: valores estimados. El c√°lculo usa curvas diarias del manual
            (Ross/Cobb).
          </p>

          <div id="shareWrap" class="mt-4 hidden">
            <label class="block text-sm text-gray-600 mb-1"
              >Comparte/guarda tu configuraci√≥n</label
            >
            <div class="flex gap-2">
              <input
                id="shareLink"
                class="flex-1 border rounded-lg p-2 text-xs"
                readonly
              />
              <button
                id="btnCopy"
                class="px-3 rounded-lg bg-[#2c6e2f] text-white text-sm"
              >
                Copiar
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">
              El enlace incluye tus entradas (aves, d√≠as, raza, bulto, precios,
              cortes y mortalidad).
            </p>
          </div>
        </div>

        <!-- Mini tabla colapsable -->
        <details id="tablaDiaria" class="mt-6 rounded-xl border p-4 bg-white">
          <summary
            class="cursor-pointer font-semibold text-[#2c6e2f] flex items-center gap-2"
          >
            <span>üìä Consumo diario oficial (g/ave) por fase</span
            ><small id="sourceTag" class="text-gray-500 font-normal"></small>
          </summary>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <h5 class="font-semibold text-sm mb-2">Preinicio</h5>
              <div class="overflow-x-auto max-h-72 border rounded-md">
                <table class="min-w-full text-xs">
                  <thead>
                    <tr class="bg-gray-100">
                      <th class="p-2 text-left">D√≠a</th>
                      <th class="p-2 text-right">g/ave</th>
                      <th class="p-2 text-right">Aves</th>
                      <th class="p-2 text-right">kg d√≠a</th>
                    </tr>
                  </thead>
                  <tbody id="tblPre"></tbody>
                  <tfoot>
                    <tr class="font-semibold bg-green-50">
                      <td class="p-2" colspan="3">Subtotal fase (kg)</td>
                      <td class="p-2 text-right" id="subKgPre">0</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            <div>
              <h5 class="font-semibold text-sm mb-2">Inicio</h5>
              <div class="overflow-x-auto max-h-72 border rounded-md">
                <table class="min-w-full text-xs">
                  <thead>
                    <tr class="bg-gray-100">
                      <th class="p-2 text-left">D√≠a</th>
                      <th class="p-2 text-right">g/ave</th>
                      <th class="p-2 text-right">Aves</th>
                      <th class="p-2 text-right">kg d√≠a</th>
                    </tr>
                  </thead>
                  <tbody id="tblIni"></tbody>
                  <tfoot>
                    <tr class="font-semibold bg-green-50">
                      <td class="p-2" colspan="3">Subtotal fase (kg)</td>
                      <td class="p-2 text-right" id="subKgIni">0</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            <div>
              <h5 class="font-semibold text-sm mb-2">Engorde</h5>
              <div class="overflow-x-auto max-h-72 border rounded-md">
                <table class="min-w-full text-xs">
                  <thead>
                    <tr class="bg-gray-100">
                      <th class="p-2 text-left">D√≠a</th>
                      <th class="p-2 text-right">g/ave</th>
                      <th class="p-2 text-right">Aves</th>
                      <th class="p-2 text-right">kg d√≠a</th>
                    </tr>
                  </thead>
                  <tbody id="tblEng"></tbody>
                  <tfoot>
                    <tr class="font-semibold bg-green-50">
                      <td class="p-2" colspan="3">Subtotal fase (kg)</td>
                      <td class="p-2 text-right" id="subKgEng">0</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </details>
      </div>
    </section>

    <!-- CTA / SUSCRIPCI√ìN -->
    <section
      id="suscripcion"
      class="max-w-md mx-auto bg-white p-6 mt-8 rounded-2xl shadow-md text-center hidden"
    >
      <h3 class="text-xl font-semibold mb-2 text-[#4f8a45]">
        ¬øTe pareci√≥ √∫til esta calculadora?
      </h3>
      <p class="text-gray-600 mb-4">
        Suscr√≠bete a nuestro bolet√≠n y recibe gu√≠as pr√°cticas y herramientas
        gratuitas para mejorar tu producci√≥n av√≠cola.
      </p>
      <form
        id="subscribeForm"
        action="https://docs.google.com/forms/d/e/1FAIpQLSdLrvwfiUP4_K8OMIAfA8mWRQ_82-E06uQF_cfIQ3amehxYpQ/formResponse"
        target="hidden_iframe"
        method="POST"
      >
        <input
          type="email"
          placeholder="Tu correo electr√≥nico"
          class="w-full border p-2 rounded-lg mb-4"
          required
          name="entry.1776799657"
          id="emailInput"
        />
        <button
          type="submit"
          class="w-full bg-[#2c6e2f] text-white p-3 rounded-lg hover:bg-[#4f8a45] transition"
        >
          Suscribirme ahora
        </button>
      </form>
      <iframe
        name="hidden_iframe"
        id="hidden_iframe"
        style="display: none"
        onload="if(submitted) { successMessage(); }"
      ></iframe>
      <p class="text-gray-500 text-sm mt-4">
        √önete a nuestra comunidad y aprende m√°s sobre avicultura circular:
      </p>
      <div class="flex justify-center gap-4 mt-3">
        <a href="https://wa.me/573152112644" target="_blank" title="WhatsApp"
          ><img
            src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/whatsapp.svg"
            class="w-6 h-6"
            alt="WhatsApp"
        /></a>
        <a
          href="https://www.facebook.com/profile.php?id=100073967926249"
          target="_blank"
          title="Facebook"
          ><img
            src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/facebook.svg"
            class="w-6 h-6"
            alt="Facebook"
        /></a>
        <a
          href="https://www.instagram.com/allpa_agricultura_4.0_sas/"
          target="_blank"
          title="Instagram"
          ><img
            src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg"
            class="w-6 h-6"
            alt="Instagram"
        /></a>
      </div>
    </section>

    <footer class="text-center text-gray-500 text-sm mt-10 mb-4">
      ¬© 2025 ALLPA Agricultura 4.0 SAS ‚Äî aviculturasostenible.com
    </footer>

    <!-- L√ìGICA -->
    <script>
      // ==== Referencias UI b√°sicas ====
      const pollosEl = document.getElementById("pollos");
      const diasEl = document.getElementById("dias");
      const diasValEl = document.getElementById("diasVal");
      const razaEl = document.getElementById("raza");
      const bultoEl = document.getElementById("bulto");

      const cortePreEl = document.getElementById("cortePre"); // fin de preinicio
      const corteIniEl = document.getElementById("corteIni"); // fin de inicio

      const chipPre = document.getElementById("chipPre");
      const chipIni = document.getElementById("chipIni");

      const precioPre = document.getElementById("precioPre");
      const precioPreNum = document.getElementById("precioPreNum");
      const precioIni = document.getElementById("precioIni");
      const precioIniNum = document.getElementById("precioIniNum");
      const precioEng = document.getElementById("precioEng");
      const precioEngNum = document.getElementById("precioEngNum");

      const mortalityRows = document.getElementById("mortalityRows");

      const kgPreEl = document.getElementById("kgPre");
      const kgIniEl = document.getElementById("kgIni");
      const kgEngEl = document.getElementById("kgEng");
      const bagsPreEl = document.getElementById("bagsPre");
      const bagsIniEl = document.getElementById("bagsIni");
      const bagsEngEl = document.getElementById("bagsEng");
      const subtotalPreEl = document.getElementById("subtotalPre");
      const subtotalIniEl = document.getElementById("subtotalIni");
      const subtotalEngEl = document.getElementById("subtotalEng");

      const kgTotalEl = document.getElementById("kgTotal");
      const bagsTotalEl = document.getElementById("bagsTotal");
      const inversionTotalEl = document.getElementById("inversionTotal");

      const preDiasTag = document.getElementById("preDias");
      const iniDiasTag = document.getElementById("iniDias");
      const engDiasTag = document.getElementById("engDias");
      const faseHint = document.getElementById("faseHint");

      const btnCalcular = document.getElementById("btnCalcular");
      const btnCompartir = document.getElementById("btnCompartir");
      const shareWrap = document.getElementById("shareWrap");
      const shareLink = document.getElementById("shareLink");
      const btnCopy = document.getElementById("btnCopy");

      const infografia = document.getElementById("infografia");
      const suscripcion = document.getElementById("suscripcion");

      const subscribeForm = document.getElementById("subscribeForm");
      let submitted = false; // Bandera para rastrear si el formulario se ha enviado

      const tblPre = document.getElementById("tblPre");
      const tblIni = document.getElementById("tblIni");
      const tblEng = document.getElementById("tblEng");
      const subKgPre = document.getElementById("subKgPre");
      const subKgIni = document.getElementById("subKgIni");
      const subKgEng = document.getElementById("subKgEng");
      const sourceTag = document.getElementById("sourceTag");

      const fmtCOP = (n) =>
        n.toLocaleString("es-CO", { style: "currency", currency: "COP" });

      function sync(rangeEl, numberEl) {
        rangeEl.addEventListener("input", () => {
          numberEl.value = rangeEl.value;
          recalcIfVisible();
        });
        numberEl.addEventListener("input", () => {
          rangeEl.value = numberEl.value;
          recalcIfVisible();
        });
      }
      sync(precioPre, precioPreNum);
      sync(precioIni, precioIniNum);
      sync(precioEng, precioEngNum);

      // ==== Curvas oficiales (g/ave/d√≠a) ====
      const rossDaily = [
        12, 16, 20, 24, 27, 31, 35, 39, 44, 48, 52, 57, 62, 67, 72, 77, 83, 88,
        94, 100, 105, 111, 117, 122, 128, 134, 139, 145, 150, 156, 161, 166,
        171, 176, 180, 185, 189, 193, 197, 201, 204, 207, 211, 213, 216, 219,
        221, 223, 225, 227, 229, 230, 231, 233, 233, 234,
      ];
      const cobbDaily = [
        14, 18, 22, 25, 29, 33, 37, 40, 44, 50, 57, 64, 73, 80, 84, 91, 98, 105,
        111, 118, 125, 131, 137, 143, 149, 154, 160, 165, 169, 174, 178, 183,
        187, 191, 194, 198, 202, 206, 209, 213, 217, 220, 224, 228, 232, 236,
        239, 243, 247, 250, 253, 256, 258, 260, 261, 262,
      ];
      function getDailyCurve(raza) {
        return raza === "ross" ? rossDaily : cobbDaily;
      }

      // ==== Utilidades de semanas / tabla mortalidad ====
      function semanasDelCiclo(d) {
        return Math.ceil(d / 7);
      }
      function rangoDiasSemana(weekIdx, totalDias) {
        const a = weekIdx * 7 + 1,
          b = Math.min(totalDias, (weekIdx + 1) * 7);
        return { a, b, dias: Math.max(0, b - a + 1) };
      }
      function renderMortalityRows() {
        const totalDias = Number(diasEl.value);
        const nSem = semanasDelCiclo(totalDias);
        const cur = mortalityRows.querySelectorAll("tr");
        if (cur.length === nSem) return;
        mortalityRows.innerHTML = "";
        const avesDefault = Number(pollosEl.value || 0) || 0;
        for (let i = 0; i < nSem; i++) {
          const r = rangoDiasSemana(i, totalDias);
          const tr = document.createElement("tr");
          tr.innerHTML = `<td class="py-2 pr-3">Semana ${i + 1}</td>
          <td class="py-2 pr-3 text-gray-500">D√≠as ${r.a}‚Äì${r.b} (${
            r.dias
          } d)</td>
          <td class="py-2"><input type="number" class="mort-input w-32 border rounded p-1" min="0" value="${avesDefault}" data-week="${i}"></td>`;
          mortalityRows.appendChild(tr);
        }
      }
      function getAvesPorSemana() {
        return Array.from(
          mortalityRows.querySelectorAll("input.mort-input")
        ).map((i) => Number(i.value || 0));
      }
      function fillMortalityWithPollos() {
        const val = Number(pollosEl.value || 0);
        if (!val) return;
        const inputs = mortalityRows.querySelectorAll("input.mort-input");
        if (!inputs.length) return;
        const nums = Array.from(inputs).map((i) => Number(i.value || 0));
        const allZeroOrEmpty = nums.every((n) => !n || n === 0);
        const allSame = nums.every((n) => n === nums[0]);
        const allSameButDifferent = allSame && nums[0] !== val;
        if (allZeroOrEmpty || allSameButDifferent) {
          inputs.forEach((inp) => (inp.value = val));
        } else {
          inputs.forEach((inp) => {
            if (Number(inp.value || 0) === 0) inp.value = val;
          });
        }
      }

      // ==== Fases con cortes din√°micos ====
      function clampCortes(totalDias) {
        let preEnd = Number(cortePreEl.value); // 11..14
        let iniEnd = Number(corteIniEl.value); // 18..28
        if (preEnd < 1) preEnd = 1;
        if (iniEnd <= preEnd) iniEnd = preEnd + 1;
        if (iniEnd > totalDias) iniEnd = totalDias;
        if (preEnd > totalDias) preEnd = totalDias;
        return { preEnd, iniEnd };
      }
      function etiquetasDias(totalDias, preEnd, iniEnd) {
        const pre = { a: 1, b: Math.min(preEnd, totalDias) };
        const ini =
          pre.b < totalDias
            ? { a: pre.b + 1, b: Math.min(iniEnd, totalDias) }
            : { a: 0, b: 0 };
        const eng =
          ini.b < totalDias ? { a: ini.b + 1, b: totalDias } : { a: 0, b: 0 };
        return { pre, ini, eng };
      }

      // UI reactividad: d√≠as/cortes
      function refreshPhaseChips() {
        chipPre.textContent = `predeterminado ${cortePreEl.value}`;
        chipIni.textContent = `predeterminado ${corteIniEl.value}`;
      }

      diasEl.addEventListener("input", () => {
        onInputsChanged();
      });
      cortePreEl.addEventListener("input", () => {
        onInputsChanged();
      });
      corteIniEl.addEventListener("input", () => {
        onInputsChanged();
      });

      function onInputsChanged() {
        const d = Number(diasEl.value);
        const semanas = Math.round(d / 7);
        diasValEl.textContent = `${d} d ¬∑ ${semanas} sem`;
        const { preEnd, iniEnd } = clampCortes(d);
        const E = etiquetasDias(d, preEnd, iniEnd);
        preDiasTag.textContent = E.pre.a ? `D√≠as ${E.pre.a}‚Äì${E.pre.b}` : "‚Äî";
        iniDiasTag.textContent = E.ini.a ? `D√≠as ${E.ini.a}‚Äì${E.ini.b}` : "‚Äî";
        engDiasTag.textContent = E.eng.a ? `D√≠as ${E.eng.a}‚Äì${E.eng.b}` : "‚Äî";
        faseHint.textContent = `Fases por d√≠as: ${
          E.pre.a ? `Preinicio ${E.pre.a}‚Äì${E.pre.b}` : "‚Äî"
        } ‚Üí ${E.ini.a ? `Inicio ${E.ini.a}‚Äì${E.ini.b}` : "‚Äî"} ‚Üí ${
          E.eng.a ? `Engorde ${E.eng.a}‚Äì${E.eng.b}` : "‚Äî"
        }`;
        refreshPhaseChips();
        renderMortalityRows();
        recalcIfVisible();
      }

      // ==== C√°lculo principal (d√≠a a d√≠a, sin mezcla) ====
      btnCalcular.addEventListener("click", calcular);
      mortalityRows.addEventListener("input", () => {
        recalcIfVisible();
      });

      function calcular() {
        const avesIniciales = Number(pollosEl.value || 0);
        const totalDias = Number(diasEl.value || 56);
        if (!avesIniciales || avesIniciales < 1) {
          alert("Por favor ingresa la cantidad de pollos.");
          return;
        }
        const raza = razaEl.value;
        const daily = getDailyCurve(raza);
        sourceTag.textContent =
          raza === "ross"
            ? "(Fuente: Ross 308 ‚Äì tabla diaria)"
            : "(Fuente: Cobb 500 ‚Äì tabla diaria)";

        renderMortalityRows();
        fillMortalityWithPollos();
        const avesSemana = getAvesPorSemana();

        const { preEnd, iniEnd } = clampCortes(totalDias);
        const E = etiquetasDias(totalDias, preEnd, iniEnd);
        const bultoKg = Number(bultoEl.value || 40);

        // Acumuladores por fase
        let pre = { kg: 0, detalle: [] },
          ini = { kg: 0, detalle: [] },
          eng = { kg: 0, detalle: [] };

        function pushDetalle(obj, d, gAve, aves) {
          const kgDia = (gAve / 1000) * aves;
          obj.kg += kgDia;
          obj.detalle.push({ d, gAve: Math.round(gAve), aves, kg: kgDia });
        }

        for (let d = 1; d <= totalDias; d++) {
          const avesDia = avesSemana[Math.ceil(d / 7) - 1] ?? avesIniciales;
          const gAve = daily[d - 1] || 0;
          if (d <= preEnd) {
            pushDetalle(pre, d, gAve, avesDia);
          } else if (d <= iniEnd) {
            pushDetalle(ini, d, gAve, avesDia);
          } else {
            pushDetalle(eng, d, gAve, avesDia);
          }
        }

        // C√°lculo de bultos y subtotales
        const pPreB = Number(precioPreNum.value || 0);
        const pIniB = Number(precioIniNum.value || 0);
        const pEngB = Number(precioEngNum.value || 0);
        const bagsPre = Math.ceil(pre.kg / bultoKg);
        const bagsIni = Math.ceil(ini.kg / bultoKg);
        const bagsEng = Math.ceil(eng.kg / bultoKg);
        const subPre = bagsPre * pPreB;
        const subIni = bagsIni * pIniB;
        const subEng = bagsEng * pEngB;

        const kgTot = Math.round(pre.kg + ini.kg + eng.kg);
        const bagsTot = bagsPre + bagsIni + bagsEng;
        const invTot = subPre + subIni + subEng;

        // Resumen
        kgPreEl.textContent = Math.round(pre.kg).toLocaleString("es-CO");
        kgIniEl.textContent = Math.round(ini.kg).toLocaleString("es-CO");
        kgEngEl.textContent = Math.round(eng.kg).toLocaleString("es-CO");
        bagsPreEl.textContent = bagsPre.toLocaleString("es-CO");
        bagsIniEl.textContent = bagsIni.toLocaleString("es-CO");
        bagsEngEl.textContent = bagsEng.toLocaleString("es-CO");
        subtotalPreEl.textContent = fmtCOP(subPre);
        subtotalIniEl.textContent = fmtCOP(subIni);
        subtotalEngEl.textContent = fmtCOP(subEng);
        kgTotalEl.textContent = kgTot.toLocaleString("es-CO");
        bagsTotalEl.textContent = bagsTot.toLocaleString("es-CO");
        inversionTotalEl.textContent = fmtCOP(invTot);

        // Render tablas diarias
        function renderTabla(tbody, data) {
          tbody.innerHTML = "";
          for (const row of data.detalle) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td class="p-2">${row.d}</td>
            <td class="p-2 text-right">${row.gAve.toLocaleString("es-CO")}</td>
            <td class="p-2 text-right">${row.aves.toLocaleString("es-CO")}</td>
            <td class="p-2 text-right">${row.kg.toFixed(2)}</td>`;
            tbody.appendChild(tr);
          }
        }
        renderTabla(tblPre, pre);
        renderTabla(tblIni, ini);
        renderTabla(tblEng, eng);
        subKgPre.textContent = Math.round(pre.kg).toLocaleString("es-CO");
        subKgIni.textContent = Math.round(ini.kg).toLocaleString("es-CO");
        subKgEng.textContent = Math.round(eng.kg).toLocaleString("es-CO");

        // Mostrar bloques y compartir
        infografia.classList.remove("hidden");
        suscripcion.classList.remove("hidden");
        btnCompartir.classList.remove("hidden");
        shareWrap.classList.remove("hidden");
        shareLink.value = buildShareURL();
      }

      function recalcIfVisible() {
        if (!infografia.classList.contains("hidden")) calcular();
      }

      // Compartir/Guardar
      function buildShareURL() {
        const base = location.origin + location.pathname;
        const p = new URLSearchParams();
        p.set("pollos", pollosEl.value || "");
        p.set("dias", diasEl.value || "");
        p.set("raza", razaEl.value || "");
        p.set("bulto", bultoEl.value || "");
        p.set("preB", precioPreNum.value || "");
        p.set("iniB", precioIniNum.value || "");
        p.set("engB", precioEngNum.value || "");
        p.set("cPre", cortePreEl.value || "");
        p.set("cIni", corteIniEl.value || "");
        const mort = getAvesPorSemana();
        if (mort.length) p.set("mort", mort.join(","));
        return `${base}?${p.toString()}`;
      }
      document
        .getElementById("btnCopy")
        ?.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(shareLink.value);
            btnCopy.textContent = "¬°Copiado!";
            setTimeout(() => (btnCopy.textContent = "Copiar"), 1200);
          } catch {
            alert("No se pudo copiar.");
          }
        });
      btnCompartir.addEventListener("click", () => {
        shareLink.value = buildShareURL();
        document
          .getElementById("shareWrap")
          .scrollIntoView({ behavior: "smooth", block: "center" });
      });

      // Restaurar desde URL
      function restoreFromURL() {
        const q = new URLSearchParams(location.search);
        const val = (k, def = "") => q.get(k) ?? def;
        if (q.has("pollos")) pollosEl.value = val("pollos");
        if (q.has("dias")) diasEl.value = val("dias");
        if (q.has("raza")) razaEl.value = val("raza");
        if (q.has("bulto")) bultoEl.value = val("bulto");
        if (q.has("preB")) {
          precioPre.value = precioPreNum.value = val("preB");
        }
        if (q.has("iniB")) {
          precioIni.value = precioIniNum.value = val("iniB");
        }
        if (q.has("engB")) {
          precioEng.value = precioEngNum.value = val("engB");
        }
        if (q.has("cPre")) cortePreEl.value = val("cPre");
        if (q.has("cIni")) corteIniEl.value = val("cIni");
        const totalDias = Number(diasEl.value || 56);
        renderMortalityRows();
        if (q.has("mort")) {
          const arr = val("mort")
            .split(",")
            .map((n) => Number(n || 0));
          const inputs = mortalityRows.querySelectorAll("input.mort-input");
          inputs.forEach((inp, idx) => {
            if (arr[idx] != null) inp.value = arr[idx];
          });
        }
        onInputsChanged();
        if (pollosEl.value && diasEl.value) {
          calcular();
        }
      }

      pollosEl.addEventListener("input", () => {
        renderMortalityRows();
        const val = Number(pollosEl.value || 0);
        const inputs = mortalityRows.querySelectorAll("input.mort-input");
        const nums = Array.from(inputs).map((i) => Number(i.value || 0));
        const allZeroOrEmpty = nums.every((n) => !n || n === 0);
        const allSame = nums.every((n) => n === nums[0]);
        const allSameButDifferent = allSame && nums[0] !== val;
        if (allZeroOrEmpty || allSameButDifferent) {
          inputs.forEach((inp) => (inp.value = val));
        } else {
          inputs.forEach((inp) => {
            if (Number(inp.value || 0) === 0) inp.value = val;
          });
        }
        recalcIfVisible();
      });

      // INIT
      renderMortalityRows();
      restoreFromURL();

      // Tests b√°sicos + adicionales
      (function () {
        try {
          const d = 56;
          const C = clampCortes(d);
          const E = etiquetasDias(d, C.preEnd, C.iniEnd);
          console.assert(
            E.pre.a === 1 && E.pre.b >= 11 && E.pre.b <= 14,
            "pre corte dentro de 11‚Äì14"
          );
          console.assert(
            Number(cortePreEl.value) === 11,
            "default pre corte = 11"
          );
          console.assert(
            E.ini.a === E.pre.b + 1 && E.ini.b >= 18 && E.ini.b <= 28,
            "ini corte dentro de 18‚Äì28"
          );
          console.assert(
            E.eng.a === E.ini.b + 1 && E.eng.b === d,
            "eng correcto"
          );
          console.assert(
            document.getElementById("btnCalcular") === btnCalcular,
            "btnCalcular referencia √∫nica"
          );
          console.assert(rossDaily.length === 56, "Ross 308: 56 d√≠as");
          console.assert(cobbDaily.length === 56, "Cobb 500: 56 d√≠as");
        } catch (e) {
          console.warn("Self-tests failed", e);
        }
      })();

      // Funci√≥n para mostrar el mensaje de √©xito
      function successMessage() {
        const socialLinks = suscripcion.querySelector(".flex.justify-center");
        suscripcion.innerHTML = `
    <h3 class="text-xl font-semibold mb-2 text-[#4f8a45]">
      ¬°Suscripci√≥n exitosa! üéâ
    </h3>
    <p class="text-gray-600 mb-4">
      Gracias por unirte. Tu correo ha sido guardado.
    </p>
    <p class="text-gray-500 text-sm mt-4">
      Mientras tanto, s√≠guenos en nuestras redes:
    </p>
  `;
        // Re-agrega los enlaces sociales
        if (socialLinks) {
          suscripcion.appendChild(socialLinks);
        }
        // Limpia la bandera
        submitted = false;
      }

      // Evento que se dispara al enviar el formulario
      if (subscribeForm) {
        subscribeForm.addEventListener("submit", function () {
          // Establece la bandera y el formulario se env√≠a al iframe
          submitted = true;
          // Opcional: limpia el campo de email
          document.getElementById("emailInput").value = "";
        });
      }
    </script>

    <script src="/assets/js/allpaFooter.js"></script>
    <script>
      // Config m√≠nimo ‚Äî cambia tu usuario de TikTok si aplica
      AllpaFooter.mount({
        tiktokUser: "stiven9708",
        tiktokWeb: "https://www.tiktok.com/@stiven9708",
        nequiNumber: "3152112644",
        nequiName: "ALLPA Agricultura 4.0",
        lang: "auto", // 'auto' | 'es' | 'en'
        delayMs: 2000,
        ttlHours: 0,
        autoShow: true,
      });

      // (Opcional) escucha eventos para anal√≠tica
      document.addEventListener("allpa:overlay_open", (e) =>
        console.log("overlay", e.detail)
      );
      document.addEventListener("allpa:copy_nequi", () =>
        console.log("copied nequi")
      );
    </script>
  </body>
</html>
